# Sprint 2, Story 4.2: Configure EKS Access with SSO

## Story Summary
Configure production-level EKS access using IAM Identity Center (SSO) with multiple user roles.

**What We're Configuring:**
- SSO Groups for different access levels
- SSO Users for demo
- EKS Access Entries for SSO roles
- Kubernetes RBAC for fine-grained access

> **â±ï¸ Time:** ~15-20 minutes
> **ğŸ“ This is the PRODUCTION-GRADE approach** using IAM Identity Center (SSO)

---

## Runbook Overview

| Part | Topic | Key Commands/Files |
|------|-------|-------------------|
| 0 | Prerequisites | Verify EKS, Identity Center |
| 1 | Architecture | Diagram + access model |
| 2 | SSO Groups | `aws identitystore create-group` |
| 3 | Demo Users | `aws identitystore create-user` |
| 4 | Group Memberships | `aws identitystore create-group-membership` |
| 5 | Permission Sets | `aws sso-admin create-permission-set` |
| 6 | Attach Policies | `aws sso-admin put-inline-policy-to-permission-set` |
| 7 | Account Assignments | `aws sso-admin create-account-assignment` |
| 8 | EKS Auth Mode | `access_config` in Terraform |
| 9 | EKS Access Entries | `eks-access.tf` Terraform |
| 10 | Kubernetes RBAC | `sso-rbac.yaml` kubectl |
| 11 | Verification | `aws eks list-access-entries` |

---

## Prerequisites
- S4.1 completed (EKS cluster running)
- IAM Identity Center enabled in your AWS account
- kubectl configured

---

## Part 0: Verify Prerequisites

### Step 0.1: Verify EKS Cluster
```bash
kubectl get nodes
# Should show nodes in Ready state
```

### Step 0.2: Verify Identity Center
```bash
aws sso-admin list-instances --query "Instances[0].{InstanceArn:InstanceArn,IdentityStoreId:IdentityStoreId}" --output json
```

Note down:
- `InstanceArn`: `arn:aws:sso:::instance/ssoins-XXXXXXXX`
- `IdentityStoreId`: `d-XXXXXXXXXX`

---

## Part 1: Understanding the Access Model

### The Architecture
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        EKS Access with SSO                                   â”‚
â”‚                                                                              â”‚
â”‚  SSO User â†’ SSO Group â†’ Permission Set â†’ IAM Role â†’ EKS Access Entry       â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ jaiadmin    â”‚â”€â”€â”€â”‚ Platform-Admins â”‚â”€â”€â”€â”‚ EKS-Platform-Admin           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â†’ AmazonEKSClusterAdminPolicyâ”‚   â”‚
â”‚                                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ devlead     â”‚â”€â”€â”€â”‚ Developers      â”‚â”€â”€â”€â”‚ EKS-Developer                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â†’ K8s RBAC (namespace-admin) â”‚   â”‚
â”‚                                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ devjunior   â”‚â”€â”€â”€â”‚ Developers-     â”‚â”€â”€â”€â”‚ EKS-ReadOnly                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ ReadOnly        â”‚   â”‚ â†’ AmazonEKSViewPolicy        â”‚   â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Access Levels
| Role | Can Do | Cannot Do |
|------|--------|-----------|
| Platform-Admin | Everything | - |
| Developer | Deploy to `dev` namespace | Modify other namespaces |
| ReadOnly | View pods, logs | Create/delete anything |

---

## Part 2: Create SSO Groups

### Step 2.1: Set Variables
```bash
# Get your Identity Store ID
IDENTITY_STORE_ID=$(aws sso-admin list-instances --query "Instances[0].IdentityStoreId" --output text)
echo "Identity Store ID: $IDENTITY_STORE_ID"
```

### Step 2.2: Create Platform-Admins Group
```bash
aws identitystore create-group \
  --identity-store-id $IDENTITY_STORE_ID \
  --display-name "Platform-Admins" \
  --description "Full EKS cluster admin access"

# Note the GroupId from output
```

### Step 2.3: Create Developers Group
```bash
aws identitystore create-group \
  --identity-store-id $IDENTITY_STORE_ID \
  --display-name "Developers" \
  --description "Developer namespace admin access"

# Note the GroupId
```

### Step 2.4: Create Developers-ReadOnly Group
```bash
aws identitystore create-group \
  --identity-store-id $IDENTITY_STORE_ID \
  --display-name "Developers-ReadOnly" \
  --description "Read-only cluster access"

# Note the GroupId
```

### Step 2.5: Verify Groups
```bash
aws identitystore list-groups --identity-store-id $IDENTITY_STORE_ID \
  --query "Groups[*].{Name:DisplayName,Id:GroupId}" --output table
```

---

## Part 3: Create Demo Users

### Step 3.1: Create Dev Lead User
```bash
aws identitystore create-user \
  --identity-store-id $IDENTITY_STORE_ID \
  --user-name devlead \
  --display-name "Dev Lead" \
  --name FamilyName=Lead,GivenName=Dev \
  --emails Value=devlead@techitfactory.local,Type=work,Primary=true

# Note the UserId
```

### Step 3.2: Create Junior Developer User
```bash
aws identitystore create-user \
  --identity-store-id $IDENTITY_STORE_ID \
  --user-name devjunior \
  --display-name "Junior Developer" \
  --name FamilyName=Developer,GivenName=Junior \
  --emails Value=devjunior@techitfactory.local,Type=work,Primary=true

# Note the UserId
```

### Step 3.3: Verify Users
```bash
aws identitystore list-users --identity-store-id $IDENTITY_STORE_ID \
  --query "Users[*].{Name:DisplayName,Id:UserId,Username:UserName}" --output table
```

---

## Part 4: Add Users to Groups

### Step 4.1: Get IDs
```bash
# Get existing user ID (your admin user)
ADMIN_USER_ID=$(aws identitystore list-users --identity-store-id $IDENTITY_STORE_ID \
  --query "Users[?UserName=='jaiadmin'].UserId" --output text)

# Get devlead user ID
DEVLEAD_USER_ID=$(aws identitystore list-users --identity-store-id $IDENTITY_STORE_ID \
  --query "Users[?UserName=='devlead'].UserId" --output text)

# Get devjunior user ID
DEVJUNIOR_USER_ID=$(aws identitystore list-users --identity-store-id $IDENTITY_STORE_ID \
  --query "Users[?UserName=='devjunior'].UserId" --output text)

# Get group IDs
PLATFORM_ADMINS_GROUP_ID=$(aws identitystore list-groups --identity-store-id $IDENTITY_STORE_ID \
  --query "Groups[?DisplayName=='Platform-Admins'].GroupId" --output text)

DEVELOPERS_GROUP_ID=$(aws identitystore list-groups --identity-store-id $IDENTITY_STORE_ID \
  --query "Groups[?DisplayName=='Developers'].GroupId" --output text)

READONLY_GROUP_ID=$(aws identitystore list-groups --identity-store-id $IDENTITY_STORE_ID \
  --query "Groups[?DisplayName=='Developers-ReadOnly'].GroupId" --output text)

echo "Groups: $PLATFORM_ADMINS_GROUP_ID, $DEVELOPERS_GROUP_ID, $READONLY_GROUP_ID"
```

### Step 4.2: Add Admin to Platform-Admins
```bash
aws identitystore create-group-membership \
  --identity-store-id $IDENTITY_STORE_ID \
  --group-id $PLATFORM_ADMINS_GROUP_ID \
  --member-id UserId=$ADMIN_USER_ID
```

### Step 4.3: Add Dev Lead to Developers
```bash
aws identitystore create-group-membership \
  --identity-store-id $IDENTITY_STORE_ID \
  --group-id $DEVELOPERS_GROUP_ID \
  --member-id UserId=$DEVLEAD_USER_ID
```

### Step 4.4: Add Junior to Developers-ReadOnly
```bash
aws identitystore create-group-membership \
  --identity-store-id $IDENTITY_STORE_ID \
  --group-id $READONLY_GROUP_ID \
  --member-id UserId=$DEVJUNIOR_USER_ID
```

---

## Part 5: Create Permission Sets

### Step 5.1: Get SSO Instance ARN
```bash
SSO_INSTANCE_ARN=$(aws sso-admin list-instances --query "Instances[0].InstanceArn" --output text)
echo "SSO Instance: $SSO_INSTANCE_ARN"
```

### Step 5.2: Create EKS-Platform-Admin Permission Set
```bash
aws sso-admin create-permission-set \
  --instance-arn $SSO_INSTANCE_ARN \
  --name "EKS-Platform-Admin" \
  --description "Full EKS cluster admin access" \
  --session-duration PT8H

# Note the PermissionSetArn
```

### Step 5.3: Create EKS-Developer Permission Set
```bash
aws sso-admin create-permission-set \
  --instance-arn $SSO_INSTANCE_ARN \
  --name "EKS-Developer" \
  --description "EKS developer namespace access" \
  --session-duration PT8H
```

### Step 5.4: Create EKS-ReadOnly Permission Set
```bash
aws sso-admin create-permission-set \
  --instance-arn $SSO_INSTANCE_ARN \
  --name "EKS-ReadOnly" \
  --description "EKS read-only access" \
  --session-duration PT8H
```

### Step 5.5: Get Permission Set ARNs
```bash
aws sso-admin list-permission-sets --instance-arn $SSO_INSTANCE_ARN \
  --query "PermissionSets" --output table
```

---

## Part 6: Attach EKS Policies to Permission Sets

### Step 6.1: Get Permission Set ARNs
```bash
# List and note the ARNs
aws sso-admin list-permission-sets --instance-arn $SSO_INSTANCE_ARN

# For each permission set, get details:
# aws sso-admin describe-permission-set --instance-arn $SSO_INSTANCE_ARN --permission-set-arn <ARN>
```

### Step 6.2: Add EKS Describe Policy to All Permission Sets
```bash
# Policy for eks describe (needed for kubectl access)
EKS_POLICY='{"Version":"2012-10-17","Statement":[{"Effect":"Allow","Action":["eks:DescribeCluster","eks:ListClusters"],"Resource":"*"}]}'

# Apply to EKS-Platform-Admin
aws sso-admin put-inline-policy-to-permission-set \
  --instance-arn $SSO_INSTANCE_ARN \
  --permission-set-arn "arn:aws:sso:::permissionSet/ssoins-XXXXX/ps-XXXXX" \
  --inline-policy "$EKS_POLICY"

# Repeat for EKS-Developer and EKS-ReadOnly
```

---

## Part 7: Assign Permission Sets to Groups

### Step 7.1: Get AWS Account ID
```bash
AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
echo "Account ID: $AWS_ACCOUNT_ID"
```

### Step 7.2: Assign Platform-Admin to Platform-Admins Group
```bash
aws sso-admin create-account-assignment \
  --instance-arn $SSO_INSTANCE_ARN \
  --target-id $AWS_ACCOUNT_ID \
  --target-type AWS_ACCOUNT \
  --permission-set-arn "arn:aws:sso:::permissionSet/ssoins-XXXXX/ps-XXXXX" \
  --principal-type GROUP \
  --principal-id $PLATFORM_ADMINS_GROUP_ID
```

### Step 7.3: Assign Developer to Developers Group
```bash
aws sso-admin create-account-assignment \
  --instance-arn $SSO_INSTANCE_ARN \
  --target-id $AWS_ACCOUNT_ID \
  --target-type AWS_ACCOUNT \
  --permission-set-arn "arn:aws:sso:::permissionSet/ssoins-XXXXX/ps-XXXXX" \
  --principal-type GROUP \
  --principal-id $DEVELOPERS_GROUP_ID
```

### Step 7.4: Assign ReadOnly to Developers-ReadOnly Group
```bash
aws sso-admin create-account-assignment \
  --instance-arn $SSO_INSTANCE_ARN \
  --target-id $AWS_ACCOUNT_ID \
  --target-type AWS_ACCOUNT \
  --permission-set-arn "arn:aws:sso:::permissionSet/ssoins-XXXXX/ps-XXXXX" \
  --principal-type GROUP \
  --principal-id $READONLY_GROUP_ID
```

### Step 7.5: Verify IAM Roles Created
```bash
# Wait 30 seconds for roles to be created
sleep 30

aws iam list-roles --query "Roles[?contains(RoleName, 'AWSReservedSSO_EKS')].{Name:RoleName,Arn:Arn}" --output table
```

---

## Part 8: Update EKS Authentication Mode

### Step 8.1: Add access_config to EKS Module
Add this to `modules/eks/main.tf` in the `aws_eks_cluster` resource:

```hcl
access_config {
  authentication_mode                         = "API_AND_CONFIG_MAP"
  bootstrap_cluster_creator_admin_permissions = true
}
```

### Step 8.2: Apply Terraform
```bash
cd environments/dev
terraform apply --auto-approve
```

---

## Part 9: Create EKS Access Entries

### Step 9.1: Create eks-access.tf
Create `environments/dev/eks-access.tf`:

```hcl
# Get current AWS account
data "aws_caller_identity" "current" {}

# Platform Admins - Full cluster admin
resource "aws_eks_access_entry" "platform_admins" {
  cluster_name  = module.eks.cluster_name
  principal_arn = "arn:aws:iam::ACCOUNT:role/aws-reserved/sso.amazonaws.com/REGION/AWSReservedSSO_EKS-Platform-Admin_XXXXX"
  type          = "STANDARD"
}

resource "aws_eks_access_policy_association" "platform_admins" {
  cluster_name  = module.eks.cluster_name
  principal_arn = aws_eks_access_entry.platform_admins.principal_arn
  policy_arn    = "arn:aws:eks::aws:cluster-access-policy/AmazonEKSClusterAdminPolicy"
  access_scope { type = "cluster" }
}

# Developers - Maps to K8s group for RBAC
resource "aws_eks_access_entry" "developers" {
  cluster_name      = module.eks.cluster_name
  principal_arn     = "arn:aws:iam::ACCOUNT:role/aws-reserved/sso.amazonaws.com/REGION/AWSReservedSSO_EKS-Developer_XXXXX"
  type              = "STANDARD"
  kubernetes_groups = ["developers"]
}

# Developers ReadOnly - View only
resource "aws_eks_access_entry" "developers_readonly" {
  cluster_name      = module.eks.cluster_name
  principal_arn     = "arn:aws:iam::ACCOUNT:role/aws-reserved/sso.amazonaws.com/REGION/AWSReservedSSO_EKS-ReadOnly_XXXXX"
  type              = "STANDARD"
  kubernetes_groups = ["developers-readonly"]
}

resource "aws_eks_access_policy_association" "developers_readonly" {
  cluster_name  = module.eks.cluster_name
  principal_arn = aws_eks_access_entry.developers_readonly.principal_arn
  policy_arn    = "arn:aws:eks::aws:cluster-access-policy/AmazonEKSViewPolicy"
  access_scope { type = "cluster" }
}
```

### Step 9.2: Apply Access Entries
```bash
terraform apply --auto-approve
```

---

## Part 10: Create Kubernetes RBAC

### Step 10.1: Create RBAC Manifest
Create `k8s-manifests/rbac/sso-rbac.yaml`:

```yaml
# Namespace for developers
apiVersion: v1
kind: Namespace
metadata:
  name: dev
---
# ClusterRole: Read-only access
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: developer-readonly
rules:
- apiGroups: ["", "apps", "batch"]
  resources: ["pods", "services", "deployments", "jobs"]
  verbs: ["get", "list", "watch"]
- apiGroups: [""]
  resources: ["pods/log"]
  verbs: ["get", "list"]
---
# ClusterRoleBinding for readonly group
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: developers-readonly-binding
subjects:
- kind: Group
  name: developers-readonly
  apiGroup: rbac.authorization.k8s.io
roleRef:
  kind: ClusterRole
  name: developer-readonly
  apiGroup: rbac.authorization.k8s.io
---
# Role: Full admin in dev namespace
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: namespace-admin
  namespace: dev
rules:
- apiGroups: ["", "apps", "batch", "networking.k8s.io"]
  resources: ["*"]
  verbs: ["*"]
---
# RoleBinding for developers group
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: developers-admin-binding
  namespace: dev
subjects:
- kind: Group
  name: developers
  apiGroup: rbac.authorization.k8s.io
roleRef:
  kind: Role
  name: namespace-admin
  apiGroup: rbac.authorization.k8s.io
```

### Step 10.2: Apply RBAC
```bash
kubectl apply -f k8s-manifests/rbac/sso-rbac.yaml
```

---

## Part 11: Verification

### Step 11.1: List Access Entries
```bash
aws eks list-access-entries --cluster-name techitfactory-dev --output table
```

### Step 11.2: View RBAC
```bash
kubectl get clusterrole developer-readonly
kubectl get clusterrolebinding developers-readonly-binding
kubectl get role -n dev
kubectl get rolebinding -n dev
```

### Step 11.3: Test Access (Optional)
```bash
# As Platform-Admin: Should work
kubectl auth can-i create pods
kubectl auth can-i delete namespaces

# As Developer: Should only work in dev namespace
kubectl auth can-i create pods -n dev
kubectl auth can-i create pods -n kube-system  # Should fail

# As ReadOnly: Should only view
kubectl auth can-i get pods
kubectl auth can-i create pods  # Should fail
```

---

## Commit and Push
```bash
cd ~/Desktop/Devops-Project/techitfactory-infra
git add .
git commit -m "Configure EKS access with SSO groups and RBAC"
git push origin main
```

---

## Key Takeaways

1. **SSO is production-grade**: Don't use IAM users for EKS access
2. **Groups > Users**: Manage access by group, not individual
3. **EKS Access Entry**: Modern approach, no kubectl needed to grant access
4. **RBAC for fine-grained**: Kubernetes RBAC controls what each role can do
5. **Namespace isolation**: Developers only access their namespaces

---

## Next: Story 4.3 (Cluster Autoscaler)
