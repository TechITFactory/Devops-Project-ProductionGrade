# Sprint 1, Story 3.2: VPC Endpoints Reference

> **üìù Note:** This story is now combined with S3.1. The VPC module includes all endpoint code.
> This document serves as a **reference** for understanding VPC endpoints.

---

## Summary

VPC Endpoints allow AWS services to be accessed from your VPC without going through the public internet or NAT Gateway.

---

## Endpoint Types

### Gateway Endpoints (FREE)
- **S3** - Object storage
- **DynamoDB** - NoSQL database

These use route tables to direct traffic. No charge!

### Interface Endpoints (~$7.50/month each)
- **ECR API** - Container registry API calls
- **ECR DKR** - Docker image pulls
- **CloudWatch Logs** - Log shipping
- **STS** - IRSA token exchange

These create ENIs in your subnets using AWS PrivateLink.

---

## Cost vs Benefit

| Endpoint | Monthly Cost | When to Enable |
|----------|--------------|----------------|
| S3 | **FREE** | Always (default) |
| ECR | ~$15 | High image pull volume |
| Logs | ~$7.50 | High log volume |
| STS | ~$7.50 | IRSA without NAT |

### Break-even Analysis
- NAT Gateway data transfer: ~$0.045/GB
- ECR endpoints: ~$15/month
- **Break-even:** ~330 GB/month of image pulls

---

## Current Configuration

In `environments/dev/main.tf`:

```hcl
module "vpc" {
  source = "../../modules/vpc"

  # ... other settings ...
  
  enable_s3_endpoint   = true   # FREE - always on
  
  # OPTIONAL: Interface endpoints (~$30/month total)
  # Uncomment for production:
  # enable_ecr_endpoints = true
  # enable_logs_endpoint = true
  # enable_sts_endpoint  = true
}
```

---

## Enabling Interface Endpoints (Optional)

If you want to enable interface endpoints:

```bash
cd ~/Desktop/Devops-Project/techitfactory-infra/environments/dev

# Edit main.tf and uncomment the endpoint lines
nano main.tf

# Apply changes
terraform plan   # Should show 5 new resources
terraform apply
```

---

## Verification

```bash
# List all endpoints in your VPC
VPC_ID=$(terraform output -raw vpc_id)

aws ec2 describe-vpc-endpoints --filters "Name=vpc-id,Values=$VPC_ID" \
  --query "VpcEndpoints[*].{Service:ServiceName,Type:VpcEndpointType,State:State}" \
  --output table
```

---

## Recommendation

| Environment | S3 | ECR | Logs | STS |
|-------------|-----|-----|------|-----|
| Learning | ‚úÖ | ‚ùå | ‚ùå | ‚ùå |
| Dev | ‚úÖ | ‚ùå | ‚ùå | ‚ùå |
| Production | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ |

**For this course:** Keep interface endpoints disabled to save ~$30/month.

---

## See Also
- **S3.1**: Full VPC deployment runbook (includes endpoint code)
- **modules/vpc/main.tf**: Endpoint implementation
- **modules/vpc/variables.tf**: Toggle variables
