# Sprint 5, Story 9.4: Prod Promotion via Release

## Story Summary
Configure production deployments triggered by GitHub releases with manual approval gates.

**What We're Implementing:**
- Release-triggered production deploys
- Manual approval gate
- Prod environment separation
- Semantic versioning

---

## Prerequisites
- S9.1-9.3 completed
- Prod environment in GitOps repo
- Separate prod namespace/cluster

---

## Part 1: Release Workflow

### Step 1.1: Create Release Workflow
```yaml
# .github/workflows/release.yml
name: Release to Production

on:
  release:
    types: [published]

env:
  AWS_REGION: ap-south-1

jobs:
  validate-release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Validate semver tag
        run: |
          TAG=${{ github.event.release.tag_name }}
          if [[ ! "$TAG" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Invalid tag format. Must be vX.Y.Z"
            exit 1
          fi
          echo "Valid release tag: $TAG"

  build-all-services:
    needs: validate-release
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    strategy:
      matrix:
        service:
          - name: api-gateway
            path: services/api-gateway
          - name: product-service
            path: services/product
          - name: order-service
            path: services/order
          - name: cart-service
            path: services/cart
          - name: user-service
            path: services/user-service
          - name: frontend
            path: services/frontend
    
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push with release tag
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.service.path }}
          push: true
          tags: |
            ${{ steps.login-ecr.outputs.registry }}/techitfactory/${{ matrix.service.name }}:${{ github.event.release.tag_name }}
            ${{ steps.login-ecr.outputs.registry }}/techitfactory/${{ matrix.service.name }}:latest

  update-prod-gitops:
    needs: build-all-services
    runs-on: ubuntu-latest
    environment: production  # Requires approval!
    
    steps:
      - name: Checkout GitOps repo
        uses: actions/checkout@v4
        with:
          repository: TechITFactory/techitfactory-gitops
          token: ${{ secrets.GITOPS_TOKEN }}
          path: gitops

      - name: Update all service tags for prod
        env:
          RELEASE_TAG: ${{ github.event.release.tag_name }}
        run: |
          cd gitops/environments/prod
          
          for service in api-gateway product-service order-service cart-service user-service frontend; do
            if [ -d "$service" ]; then
              yq -i '.images[0].newTag = env(RELEASE_TAG)' $service/kustomization.yaml
              echo "Updated $service to $RELEASE_TAG"
            fi
          done

      - name: Commit and push
        run: |
          cd gitops
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@techitfactory.com"
          git add .
          git commit -m "release: Promote ${{ github.event.release.tag_name }} to production"
          git push

  notify-release:
    needs: update-prod-gitops
    runs-on: ubuntu-latest
    steps:
      - name: Send Slack notification
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "ðŸš€ *Production Release*: ${{ github.event.release.tag_name }}",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "ðŸš€ *Production Release*\n*Version:* ${{ github.event.release.tag_name }}\n*Release Notes:* ${{ github.event.release.html_url }}"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
```

---

## Part 2: Environment Protection

### Configure GitHub Environment
1. Go to Repository â†’ Settings â†’ Environments
2. Create environment: `production`
3. Add protection rules:
   - âœ“ Required reviewers (add team leads)
   - âœ“ Wait timer: 5 minutes (optional)
   - âœ“ Deployment branches: tags only

### Approval Flow
```
Release Published
       â†“
Build all images with release tag
       â†“
ðŸ”’ WAIT FOR APPROVAL
       â†“
Update prod GitOps
       â†“
ArgoCD syncs prod (manual sync recommended)
```

---

## Part 3: Create Prod Environment in GitOps

### Step 3.1: Prod Overlays
```bash
cd techitfactory-gitops/environments
mkdir -p prod/{api-gateway,product-service,order-service,cart-service,user-service,frontend}

# Copy from dev and modify
for svc in api-gateway product-service order-service cart-service user-service frontend; do
  cp dev/$svc/kustomization.yaml prod/$svc/
  # Update namespace in prod configs
  sed -i 's/namespace: techitfactory/namespace: techitfactory-prod/' prod/$svc/kustomization.yaml
done
```

### Step 3.2: Prod Kustomization Example
```yaml
# environments/prod/api-gateway/kustomization.yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: techitfactory-prod

resources:
  - ../../../base/api-gateway

images:
  - name: IMAGE_PLACEHOLDER
    newName: <AWS_ACCOUNT>.dkr.ecr.ap-south-1.amazonaws.com/techitfactory/api-gateway
    newTag: v1.0.0  # Set by release workflow

replicas:
  - name: api-gateway
    count: 3  # More replicas in prod

patches:
  - patch: |-
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/cpu
        value: 200m
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/cpu
        value: 1000m
    target:
      kind: Deployment
      name: api-gateway
```

---

## Part 4: ArgoCD Prod Configuration

### Prod App with Manual Sync
```yaml
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: api-gateway-prod
  namespace: argocd
spec:
  project: production  # Separate project for prod
  source:
    repoURL: https://github.com/TechITFactory/techitfactory-gitops.git
    path: environments/prod/api-gateway
  destination:
    server: https://kubernetes.default.svc
    namespace: techitfactory-prod
  syncPolicy:
    # NO automated sync for prod - manual only!
    syncOptions:
      - CreateNamespace=true
```

### Manual Sync Command
```bash
# After release is approved
argocd app sync api-gateway-prod
argocd app sync product-service-prod
# ... etc
```

---

## Part 5: Creating a Release

### Via GitHub UI
1. Go to Releases â†’ Draft new release
2. Create tag: `v1.0.0`
3. Title: `Release v1.0.0`
4. Write release notes
5. Publish release

### Via CLI
```bash
# Tag and push
git tag v1.0.0
git push origin v1.0.0

# Create release with gh CLI
gh release create v1.0.0 --title "Release v1.0.0" --notes "First production release"
```

---

## Verification

### Checklist
1. Create release with correct tag format
2. Verify all services build with release tag
3. Wait for approval prompt
4. Approve deployment
5. Verify GitOps repo updated with release tag
6. Manually sync ArgoCD (or auto if configured)
7. Verify prod deployment

---

## Story Completion Checklist
- [ ] Release workflow created
- [ ] GitHub environment `production` configured
- [ ] Required reviewers set
- [ ] Prod overlays in GitOps
- [ ] ArgoCD prod apps created
- [ ] Test release flow end-to-end
- [ ] Slack notifications working

---

## Epic 9 Complete! ðŸŽ‰

**What we built:**
- Per-service CI workflows
- SonarCloud quality gates
- Automatic dev deployments
- Controlled prod releases with approval
