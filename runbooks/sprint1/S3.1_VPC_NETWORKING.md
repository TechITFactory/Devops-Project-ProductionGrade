# Sprint 1, Story 3.1+3.2: Provision VPC with Endpoints

## Story Summary
Implement the complete VPC module with multi-AZ networking for EKS, including VPC endpoints for cost optimization.

**What We're Building:**
- VPC with DNS support (10.0.0.0/16)
- 2 Public Subnets (for ALB, NAT)
- 2 Private Subnets (for EKS nodes)
- Internet Gateway
- Single NAT Gateway (cost-optimized)
- Route Tables
- S3 VPC Endpoint (FREE - always enabled)
- Interface Endpoints code (ECR, Logs, STS - disabled by default)

> **ğŸ’¡ Cost Note:** S3 Gateway endpoint is FREE. Interface endpoints cost ~$7.50/month each.
> For learning, we keep interface endpoints disabled. The code is ready - just uncomment when needed.

---

## Prerequisites
- S2.1-S2.3 completed (bootstrap + module skeleton)
- AWS credentials configured

---

## Part 0: Verify Prerequisites

### Step 0.1: Verify AWS Credentials
```bash
# Check AWS identity
aws sts get-caller-identity

# Expected output:
# {
#     "UserId": "AIDAXXXXXXXXXX",
#     "Account": "123456789012",
#     "Arn": "arn:aws:iam::123456789012:user/your-user"
# }
```

### Step 0.2: Verify Bootstrap Completed
```bash
cd ~/Desktop/Devops-Project/techitfactory-infra/bootstrap

# Get state bucket name - COPY THIS VALUE
terraform output state_bucket_name
# Example: techitfactory-terraform-state-123456789012

# Get lock table name - COPY THIS VALUE
terraform output lock_table_name
# Example: techitfactory-terraform-locks

# Get AWS account ID
aws sts get-caller-identity --query Account --output text
# Example: 123456789012
```

---

## Part 1: Review VPC Module (Already Complete)

> **âœ… The VPC module code is already complete in the repo!**
> In this section, we'll review the code structure before applying.

### Step 1.1: Navigate to VPC Module
```bash
cd ~/Desktop/Devops-Project/techitfactory-infra/modules/vpc

# List files
ls -la
# Should see: main.tf, variables.tf, outputs.tf, README.md
```

### Step 1.2: Review Variables
```bash
# View the variables (inputs)
cat variables.tf

# Key variables to note:
# - project_name: for naming resources
# - environment: dev/prod
# - vpc_cidr: default 10.0.0.0/16
# - single_nat_gateway: true for cost savings
# - enable_s3_endpoint: true (FREE!)
# - enable_ecr_endpoints: false (optional, ~$15/mo)
# - enable_logs_endpoint: false (optional, ~$7.50/mo)
# - enable_sts_endpoint: false (optional, ~$7.50/mo)
```

### Step 1.3: Review Main Configuration
```bash
# View main.tf (key resources)
head -100 main.tf

# Resources created:
# - aws_vpc.main (with DNS support)
# - aws_internet_gateway.main
# - aws_subnet.public (2 AZs) - tagged for ALB
# - aws_subnet.private (2 AZs) - tagged for internal ALB
# - aws_eip.nat + aws_nat_gateway.main
# - aws_route_table.public / private
# - aws_vpc_endpoint.s3 (Gateway - FREE)
# - aws_vpc_endpoint.ecr_api/dkr (Interface - optional)
# - aws_vpc_endpoint.logs (Interface - optional)
# - aws_vpc_endpoint.sts (Interface - optional)
```

### Step 1.4: Review Outputs
```bash
cat outputs.tf

# Key outputs:
# - vpc_id â†’ needed by EKS
# - private_subnet_ids â†’ EKS nodes go here
# - public_subnet_ids â†’ ALB goes here
# - nat_public_ips â†’ for allowlisting
```

### VPC Endpoint Cost Summary

| Endpoint | Type | Cost | Our Setting |
|----------|------|------|-------------|
| S3 | Gateway | **FREE** | âœ… Enabled |
| ECR (api+dkr) | Interface | ~$15/mo | âŒ Disabled |
| CloudWatch Logs | Interface | ~$7.50/mo | âŒ Disabled |
| STS | Interface | ~$7.50/mo | âŒ Disabled |

> **ğŸ’¡ For Production:** Uncomment interface endpoints for security (traffic stays in AWS network).
> **ğŸ’¡ For Learning:** Keep disabled to save ~$30/month.

---

## Part 2: Configure Dev Environment

### Step 2.1: Navigate to Dev Environment
```bash
cd ~/Desktop/Devops-Project/techitfactory-infra/environments/dev

# Confirm location
pwd
```

### Step 2.2: Review Dev main.tf
```bash
# View the current configuration
cat main.tf

# The VPC module is already configured with:
# - single_nat_gateway = true (cost optimization)
# - enable_s3_endpoint = true (FREE)
# - Interface endpoints are COMMENTED OUT (disabled)
```

### Step 2.3: Create/Update backend.tf
```bash
# Replace YOUR_ACCOUNT_ID with your actual AWS account ID
cat > backend.tf << 'EOF'
terraform {
  backend "s3" {
    bucket         = "techitfactory-terraform-state-YOUR_ACCOUNT_ID"
    key            = "environments/dev/terraform.tfstate"
    region         = "ap-south-1"
    encrypt        = true
    dynamodb_table = "techitfactory-terraform-locks"
  }
}
EOF

# Edit to replace YOUR_ACCOUNT_ID with actual value
nano backend.tf
# OR use sed:
# sed -i 's/YOUR_ACCOUNT_ID/123456789012/g' backend.tf
```

### Step 2.4: Verify Backend Configuration
```bash
cat backend.tf
# Confirm bucket name matches your bootstrap output
```

---

## Part 3: Apply VPC

### Step 3.1: Initialize Terraform
```bash
cd ~/Desktop/Devops-Project/techitfactory-infra/environments/dev

terraform init
# If prompted about migrating state, type 'yes'
```

### Step 3.2: Plan Changes
```bash
terraform plan

# Should show resources to create:
# - 1 VPC
# - 1 Internet Gateway
# - 2 Public Subnets
# - 2 Private Subnets
# - 1 EIP
# - 1 NAT Gateway
# - Route Tables + associations
# - 1 S3 Endpoint (FREE)
#
# Total: ~12-14 resources
```

### Step 3.3: Apply
```bash
terraform apply

# Review the plan, then type 'yes' to confirm
# This will take 2-3 minutes (NAT Gateway creation)
```

### Step 3.4: Verify Outputs
```bash
# View outputs
terraform output

# Note these values - needed for EKS later:
# - vpc_id
# - private_subnet_ids
# - public_subnet_ids
```

---

## Part 4: Verification

### Step 4.1: Check VPC in AWS
```bash
# Get VPC ID
VPC_ID=$(terraform output -raw vpc_id)
echo "VPC ID: $VPC_ID"

# Describe VPC
aws ec2 describe-vpcs --vpc-ids $VPC_ID \
  --query "Vpcs[0].{ID:VpcId,CIDR:CidrBlock,DNS:EnableDnsHostnames}"
```

### Step 4.2: Check Subnets
```bash
aws ec2 describe-subnets --filters "Name=vpc-id,Values=$VPC_ID" \
  --query "Subnets[*].{Name:Tags[?Key=='Name'].Value|[0],AZ:AvailabilityZone,CIDR:CidrBlock}" \
  --output table
```

### Step 4.3: Check NAT Gateway
```bash
aws ec2 describe-nat-gateways --filter "Name=vpc-id,Values=$VPC_ID" \
  --query "NatGateways[*].{ID:NatGatewayId,State:State,PublicIP:NatGatewayAddresses[0].PublicIp}" \
  --output table
```

### Step 4.4: Check S3 Endpoint
```bash
aws ec2 describe-vpc-endpoints --filters "Name=vpc-id,Values=$VPC_ID" \
  --query "VpcEndpoints[*].{ID:VpcEndpointId,Service:ServiceName,Type:VpcEndpointType,State:State}" \
  --output table
```

---

## Cost Summary

```
VPC: Free
Subnets: Free
Internet Gateway: Free
NAT Gateway: ~$32/month (+ $0.045/GB data transfer)
Elastic IP: Free (when attached)
S3 Endpoint (Gateway): FREE

Total: ~$32/month for NAT Gateway
```

---

## Commit and Push

```bash
cd ~/Desktop/Devops-Project/techitfactory-infra
git add .
git commit -m "Deploy VPC with S3 endpoint"
git push origin main
```

---

## Story Completion Checklist
- [ ] AWS credentials verified
- [ ] Bootstrap outputs noted
- [ ] VPC module reviewed
- [ ] Backend configured with correct bucket
- [ ] terraform init successful
- [ ] terraform apply successful
- [ ] VPC created with correct CIDR
- [ ] 2 public + 2 private subnets created
- [ ] NAT Gateway running
- [ ] S3 endpoint enabled (FREE)
- [ ] Changes committed and pushed

---

## Next: Story 4.1 (EKS Cluster)
With VPC ready, we can now provision the EKS cluster using the private subnets.
