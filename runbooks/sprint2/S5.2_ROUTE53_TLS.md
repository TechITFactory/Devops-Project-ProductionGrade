# Sprint 2, Story 5.2: Configure Route53 + TLS (HTTPS)

## Story Summary
Set up custom domain with Route53 and enable HTTPS with AWS Certificate Manager.

---

## Why Are We Doing This?

**The Problem:**
Your app works at `http://k8s-xxx.elb.amazonaws.com` but:
- Ugly URL that nobody can remember
- HTTP only (no lock icon = users don't trust it)
- Browsers now warn about "Not Secure"

**The Solution:**
| Component | What It Does | Why |
|-----------|--------------|-----|
| Route53 | DNS management | `app.yourdomain.com` â†’ ALB |
| ACM | TLS certificate | Free HTTPS (the lock icon) |
| Ingress annotations | Configure ALB | Enable HTTPS + redirect |

**After this story:**
```
Before: http://k8s-default-xxx.elb.amazonaws.com
After:  https://app.techitfactory.com ðŸ”’
```

---

## Runbook Overview

| Part | What We're Doing | Why |
|------|------------------|-----|
| 0 | Prerequisites | Need domain + ALB Controller |
| 1 | Route53 | Create DNS zone for domain |
| 2 | ACM Certificate | Get free TLS cert |
| 3 | HTTPS Ingress | Configure ALB for HTTPS |
| 4 | DNS Record | Point domain to ALB |
| 5 | Test | Prove HTTPS works |

---

## Prerequisites
- S5.1 completed (know how to create Ingress)
- **Domain name** you own (e.g., from GoDaddy, Namecheap)
- OR skip to "Without Domain" section at the end

---

## Part 1: Create Route53 Hosted Zone

### Why Route53?

**Route53 is AWS's DNS service.** It converts domain names to IP addresses.

When someone types `app.yourdomain.com`:
1. Browser asks DNS "What's the IP?"
2. Route53 responds "It's at this ALB address"
3. Browser connects to ALB

### Step 1.1: Create Hosted Zone (AWS Console)
1. Go to **Route53** â†’ **Hosted zones** â†’ **Create hosted zone**
2. **Domain name:** `yourdomain.com`
3. **Type:** Public hosted zone
4. Click **Create hosted zone**

### Step 1.2: Note Name Servers
After creation, you'll see 4 NS records like:
```
ns-123.awsdns-12.org
ns-456.awsdns-34.co.uk
ns-789.awsdns-56.net
ns-012.awsdns-78.com
```

### Step 1.3: Update Domain Registrar

**Why?** Your domain registrar (GoDaddy, Namecheap) currently controls your domain. You need to tell it "Route53 is now in charge."

1. Login to your domain registrar
2. Find **Nameservers** or **DNS** settings
3. Change to **Custom nameservers**
4. Enter all 4 Route53 nameservers
5. Save changes

**Wait time:** DNS propagation takes 10 min to 48 hours.

### Step 1.4: Verify Propagation
```bash
dig NS yourdomain.com +short
# Should show Route53 nameservers
```

---

## Part 2: Request ACM Certificate (Free TLS)

### Why ACM?

**ACM = AWS Certificate Manager.** It gives you free TLS certificates.

Without ACM:
- Pay $50-200/year for certificate
- Manually renew before expiry
- Upload to AWS manually

With ACM:
- **FREE** certificates
- **Auto-renewing** (never expires)
- **Integrated** with ALB (one annotation)

### Step 2.1: Request Certificate (AWS Console)
1. Go to **Certificate Manager (ACM)**
2. Make sure you're in **ap-south-1** (same region as EKS)
3. Click **Request certificate** â†’ **Request public certificate**
4. **Domain names:**
   - `yourdomain.com`
   - `*.yourdomain.com` (wildcard for all subdomains)
5. **Validation method:** DNS validation
6. Click **Request**

### Step 2.2: Add DNS Validation Records

**Why DNS validation?**
AWS needs to verify you own the domain. You do this by adding a special DNS record.

1. In ACM, click the certificate
2. Click **Create records in Route53** (if using Route53)
3. Click **Create records**

If manual:
1. Copy the CNAME record name and value
2. Add to Route53 as CNAME record

### Step 2.3: Wait for Validation
```bash
aws acm list-certificates --query "CertificateSummaryList[*].{Domain:DomainName,Status:Status}" --output table
```

**Status progression:**
- `PENDING_VALIDATION` â†’ waiting for DNS check
- `ISSUED` â†’ ready to use! âœ…

This takes 5-30 minutes.

### Step 2.4: Get Certificate ARN
```bash
aws acm list-certificates --query "CertificateSummaryList[?DomainName=='yourdomain.com'].CertificateArn" --output text
```

Note this ARN - you'll use it in the Ingress!

---

## Part 3: Create HTTPS Ingress

### Understanding HTTPS Annotations

| Annotation | What It Does |
|------------|--------------|
| `certificate-arn` | Use this ACM certificate |
| `listen-ports` | Listen on 80 and 443 |
| `ssl-redirect: '443'` | Redirect HTTPâ†’HTTPS |

### Step 3.1: Deploy App (if not running)
```bash
kubectl apply -f - <<EOF
apiVersion: apps/v1
kind: Deployment
metadata:
  name: hello-app
spec:
  replicas: 2
  selector:
    matchLabels:
      app: hello-app
  template:
    metadata:
      labels:
        app: hello-app
    spec:
      containers:
      - name: hello
        image: hashicorp/http-echo
        args: ["-text=Hello from TechITFactory over HTTPS!"]
        ports:
        - containerPort: 5678
---
apiVersion: v1
kind: Service
metadata:
  name: hello-app
spec:
  selector:
    app: hello-app
  ports:
  - port: 80
    targetPort: 5678
EOF
```

### Step 3.2: Create HTTPS Ingress
```bash
# Replace with your certificate ARN
CERT_ARN="arn:aws:acm:ap-south-1:ACCOUNT:certificate/xxx"

kubectl apply -f - <<EOF
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: hello-app
  annotations:
    alb.ingress.kubernetes.io/scheme: internet-facing
    alb.ingress.kubernetes.io/target-type: ip
    alb.ingress.kubernetes.io/certificate-arn: ${CERT_ARN}
    alb.ingress.kubernetes.io/listen-ports: '[{"HTTP": 80}, {"HTTPS": 443}]'
    alb.ingress.kubernetes.io/ssl-redirect: '443'
spec:
  ingressClassName: alb
  rules:
  - host: app.yourdomain.com  # Your subdomain
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: hello-app
            port:
              number: 80
EOF
```

**What this does:**
1. Creates ALB with HTTPS listener on 443
2. Attaches your ACM certificate
3. Redirects HTTP (80) to HTTPS (443)
4. Only responds to `app.yourdomain.com` host

---

## Part 4: Create DNS Record

### Step 4.1: Get ALB Hostname
```bash
kubectl get ingress hello-app -o jsonpath='{.status.loadBalancer.ingress[0].hostname}'
```

### Step 4.2: Create Route53 Record (Console)
1. Go to **Route53** â†’ **Hosted zones** â†’ Click your domain
2. Click **Create record**
3. **Record name:** `app` (for app.yourdomain.com)
4. **Record type:** A
5. **Alias:** Yes
6. **Route traffic to:**
   - Alias to Application Load Balancer
   - Region: ap-south-1
   - Select your ALB
7. Click **Create records**

### Step 4.3: Wait for DNS
```bash
dig app.yourdomain.com +short
# Should return ALB hostname
```

---

## Part 5: Test HTTPS Access

### Step 5.1: Test HTTP (should redirect)
```bash
curl -I http://app.yourdomain.com
# Should show: HTTP/1.1 301 Moved Permanently
# Location: https://app.yourdomain.com/
```

### Step 5.2: Test HTTPS
```bash
curl https://app.yourdomain.com
# Should return: Hello from TechITFactory over HTTPS!
```

### Step 5.3: Verify Certificate
```bash
echo | openssl s_client -connect app.yourdomain.com:443 2>/dev/null | openssl x509 -noout -dates

# Or in browser:
# Click the ðŸ”’ icon â†’ "Connection is secure" â†’ Certificate details
```

---

## Without a Domain (Testing Only)

If you don't have a domain, you can still test HTTPS:

### Option 1: Use ALB DNS directly (no custom domain)
```bash
ALB_URL=$(kubectl get ingress hello-app -o jsonpath='{.status.loadBalancer.ingress[0].hostname}')
curl http://$ALB_URL
```

### Option 2: Use nip.io (free wildcard DNS)
```bash
ALB_IP=$(host $ALB_URL | tail -1 | awk '{print $NF}')
echo "Access at: http://$ALB_IP.nip.io"
```

---

## Troubleshooting

### "Certificate not found"
```bash
# Check certificate exists in SAME REGION as EKS
aws acm list-certificates --region ap-south-1

# Certificate ARN must be for ap-south-1
```

### "HTTPS not working"
```bash
# Check listener has 443
aws elbv2 describe-listeners \
  --load-balancer-arn $(aws elbv2 describe-load-balancers \
    --query "LoadBalancers[?contains(DNSName, 'k8s-default')].LoadBalancerArn" --output text) \
  --query "Listeners[*].{Port:Port,Protocol:Protocol}"
```

### "DNS not resolving"
```bash
# Check Route53 record exists
aws route53 list-resource-record-sets --hosted-zone-id ZONEID \
  --query "ResourceRecordSets[?Name=='app.yourdomain.com.']"

# Wait for DNS propagation
dig app.yourdomain.com +trace
```

---

## Cost Summary

| Resource | Monthly Cost |
|----------|--------------|
| Route53 Hosted Zone | $0.50 |
| ACM Certificate | **FREE** |
| DNS Queries | ~$0.40/million |
| ALB | ~$16 + $0.008/LCU |

---

## Key Takeaways

1. **Route53 for DNS** â†’ `app.yourdomain.com` becomes real
2. **ACM for certificates** â†’ Free, auto-renewing TLS
3. **Ingress annotations** â†’ Configure everything declaratively
4. **ssl-redirect** â†’ Automatic HTTP to HTTPS redirect

---

## Epic 5 Complete! ðŸŽ‰

**What you have now:**
- âœ… Custom domain pointing to your app
- âœ… HTTPS with valid certificate (lock icon)
- âœ… Automatic HTTPâ†’HTTPS redirect
- âœ… Production-ready ingress setup

**Next: Epic 6 (CI/CD Pipeline)**
