# Sprint 5, Story 9.3: Dev Auto-Deploy on Merge

## Story Summary
Configure automatic deployment to dev environment when code is merged to main.

**What We're Implementing:**
- Automatic image tag updates in GitOps repo
- ArgoCD auto-sync for dev namespace
- Slack notifications

---

## Prerequisites
- S9.1 completed (GitHub Actions workflows)
- ArgoCD installed and configured
- GitOps repository ready

---

## Part 1: GitOps Update Flow

### The Flow
```
Code Merged to main
       ↓
GitHub Actions builds image
       ↓
Push image to ECR
       ↓
Update GitOps repo (new image tag)
       ↓
ArgoCD detects change
       ↓
ArgoCD syncs to cluster
       ↓
New version deployed!
```

---

## Part 2: Update GitOps Step

### Full Update Job
```yaml
# Add to each service workflow
update-gitops:
  needs: build
  runs-on: ubuntu-latest
  if: github.ref == 'refs/heads/main'
  
  steps:
    - name: Checkout GitOps repo
      uses: actions/checkout@v4
      with:
        repository: TechITFactory/techitfactory-gitops
        token: ${{ secrets.GITOPS_TOKEN }}
        path: gitops

    - name: Update image tag in kustomization.yaml
      env:
        SERVICE_NAME: api-gateway  # Change per service
        IMAGE_TAG: ${{ github.sha }}
      run: |
        cd gitops/environments/dev/${SERVICE_NAME}
        
        # Update the newTag in kustomization.yaml
        yq -i '.images[0].newTag = env(IMAGE_TAG)' kustomization.yaml
        
        # Show the change
        cat kustomization.yaml

    - name: Commit and push
      run: |
        cd gitops
        git config user.name "GitHub Actions Bot"
        git config user.email "actions@techitfactory.com"
        
        git add .
        git diff --staged --quiet || git commit -m "chore: Update ${SERVICE_NAME} to ${IMAGE_TAG}"
        git push
```

---

## Part 3: ArgoCD Auto-Sync

### Verify Auto-Sync is Enabled
```yaml
# In ArgoCD Application
syncPolicy:
  automated:
    prune: true     # Delete resources not in git
    selfHeal: true  # Revert manual changes
```

### Check Application Status
```bash
argocd app get api-gateway
argocd app sync-status api-gateway
```

---

## Part 4: Deployment Notifications

### Slack Notification
```yaml
notify-deploy:
  needs: update-gitops
  runs-on: ubuntu-latest
  if: success()
  
  steps:
    - name: Send Slack notification
      uses: slackapi/slack-github-action@v1
      with:
        payload: |
          {
            "blocks": [
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "✅ *Deployed to Dev*\n*Service:* ${{ github.event.repository.name }}\n*Commit:* `${{ github.sha }}`\n*By:* ${{ github.actor }}"
                }
              },
              {
                "type": "actions",
                "elements": [
                  {
                    "type": "button",
                    "text": {"type": "plain_text", "text": "View Commit"},
                    "url": "${{ github.event.head_commit.url }}"
                  }
                ]
              }
            ]
          }
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
```

---

## Part 5: Deployment Verification

### Health Check After Deploy
```yaml
verify-deploy:
  needs: update-gitops
  runs-on: ubuntu-latest
  if: success()
  
  steps:
    - name: Wait for ArgoCD sync
      run: sleep 60  # Wait for ArgoCD to pick up change

    - name: Configure AWS & kubectl
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
        aws-region: ap-south-1

    - name: Update kubeconfig
      run: aws eks update-kubeconfig --name techitfactory-dev --region ap-south-1

    - name: Wait for deployment rollout
      run: |
        kubectl rollout status deployment/${SERVICE_NAME} -n techitfactory --timeout=300s

    - name: Verify health endpoint
      run: |
        POD=$(kubectl get pods -n techitfactory -l app=${SERVICE_NAME} -o jsonpath='{.items[0].metadata.name}')
        kubectl exec -n techitfactory $POD -- wget -q -O- http://localhost:3000/health
```

---

## Part 6: Rollback Strategy

### Manual Rollback
```bash
# Via ArgoCD CLI
argocd app rollback api-gateway

# Via kubectl
kubectl rollout undo deployment/api-gateway -n techitfactory

# Via GitOps (revert commit)
cd techitfactory-gitops
git revert HEAD
git push
```

### Automatic Rollback on Health Check Failure
```yaml
- name: Rollback on failure
  if: failure()
  run: |
    echo "Deployment failed, triggering rollback..."
    kubectl rollout undo deployment/${SERVICE_NAME} -n techitfactory
```

---

## Verification

### End-to-End Test
1. Make a small code change
2. Create PR and merge to main
3. Watch GitHub Actions run
4. Check ECR for new image
5. Check GitOps repo for updated tag
6. Verify ArgoCD synced
7. Test the deployed endpoint

---

## Story Completion Checklist
- [ ] GitOps update step in all workflows
- [ ] GITOPS_TOKEN secret configured
- [ ] ArgoCD auto-sync verified
- [ ] Slack notifications (optional)
- [ ] Health check verification
- [ ] Rollback tested

---

## Next: Story 9.4 (Prod Promotion)
