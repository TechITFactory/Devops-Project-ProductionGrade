# Sprint 2, Story 4.1: Provision EKS Cluster

## Story Summary
Deploy the EKS cluster using the already-complete EKS module.

**What We're Deploying:**
- EKS Control Plane with OIDC
- Managed Node Group (2x t3.medium)
- IAM Roles for cluster and nodes
- EBS CSI Driver for PersistentVolumes
- OIDC Provider for IRSA
- Cluster Autoscaler IRSA role
- ALB Controller IRSA role

> **â±ï¸ Time:** EKS cluster creation takes ~15-20 minutes.  
> **ðŸ’° Cost:** ~$147/month (control plane $72 + nodes $60 + EBS $10 + logs $5)

---

## Prerequisites
- S3.1 completed (VPC deployed)
- VPC outputs available (vpc_id, private_subnet_ids)
- AWS credentials configured

---

## Part 0: Verify Prerequisites

### Step 0.1: Verify VPC is Deployed
```bash
cd ~/Desktop/Devops-Project/techitfactory-infra/environments/dev

# Check VPC outputs
terraform output vpc_id
terraform output private_subnet_ids

# If you get errors, complete S3.1 first!
```

### Step 0.2: Verify EKS Module Exists
```bash
cd ~/Desktop/Devops-Project/techitfactory-infra

# Check EKS module
ls -la modules/eks/
# Should see: main.tf, variables.tf, outputs.tf
```

---

## Part 1: Review EKS Module (Already Complete)

> **âœ… The EKS module code is already complete in the repo!**
> In this section, we'll review the code structure before applying.

### Step 1.1: Navigate to EKS Module
```bash
cd ~/Desktop/Devops-Project/techitfactory-infra/modules/eks

# List files
ls -la
```

### Step 1.2: Review Variables
```bash
cat variables.tf

# Key variables:
# - project_name, environment: naming
# - cluster_version: Kubernetes version (1.28)
# - vpc_id, subnet_ids: from VPC module
# - node_desired_size: number of nodes (default: 2)
# - node_instance_types: EC2 type (default: t3.medium)
# - enable_ebs_csi_driver: for PersistentVolumes
# - enable_cluster_autoscaler: IRSA role for autoscaler
# - enable_alb_controller: IRSA role for ALB controller
```

### Step 1.3: Review Main Configuration
```bash
# View first 100 lines (architecture + IAM roles)
head -100 main.tf

# Resources created:
# - aws_iam_role.cluster (cluster IAM role)
# - aws_security_group.cluster (cluster security group)
# - aws_eks_cluster.main (the cluster!)
# - aws_iam_openid_connect_provider (OIDC for IRSA)
# - aws_iam_role.node (node IAM role)
# - aws_eks_node_group.main (managed node group)
# - aws_eks_addon.ebs_csi (EBS CSI Driver)
# - aws_eks_addon.coredns, kube_proxy, vpc_cni
# - aws_iam_role.cluster_autoscaler (IRSA)
# - aws_iam_role.alb_controller (IRSA)
```

### Step 1.4: Review Outputs
```bash
cat outputs.tf

# Key outputs:
# - cluster_name, cluster_endpoint
# - kubeconfig_command (to configure kubectl)
# - oidc_provider_arn (for IRSA)
# - cluster_autoscaler_role_arn
# - alb_controller_role_arn
```

---

## Part 2: Enable EKS Module in Dev Environment

### Step 2.1: Navigate to Dev Environment
```bash
cd ~/Desktop/Devops-Project/techitfactory-infra/environments/dev
```

### Step 2.2: Enable EKS Module in main.tf
```bash
# Edit main.tf and remove the /* */ around the EKS module block
nano main.tf

# Find this section and remove the /* at the start and */ at the end:
# 
# /*
# module "eks" {
#   source = "../../modules/eks"
#   ...
# }
# */
#
# Should become:
#
# module "eks" {
#   source = "../../modules/eks"
#   ...
# }
```

### Step 2.3: Enable EKS Outputs in outputs.tf
```bash
# Edit outputs.tf and remove /* */ around EKS outputs
nano outputs.tf

# Uncomment all EKS outputs
```

### Step 2.4: Verify Changes
```bash
# Check the module is uncommented
grep -A 5 "module \"eks\"" main.tf
# Should show the module block without comment markers
```

---

## Part 3: Apply EKS

### Step 3.1: Initialize (to pick up EKS module)
```bash
terraform init -upgrade
```

### Step 3.2: Plan
```bash
terraform plan

# Should show ~20-25 new resources:
# - EKS Cluster
# - IAM Roles (cluster, node, ebs-csi, autoscaler, alb-controller)
# - Security Group
# - Node Group
# - EKS Add-ons (CoreDNS, kube-proxy, VPC-CNI, EBS-CSI)
# - OIDC Provider
```

### Step 3.3: Apply (Takes 15-20 minutes)
```bash
terraform apply

# Type 'yes' when prompted
# This takes 15-20 minutes - EKS cluster creation is slow
```

### Step 3.4: Get Outputs
```bash
terraform output

# Note the kubeconfig_command output
```

---

## Part 4: Configure kubectl

### Step 4.1: Update kubeconfig
```bash
# Get the command from Terraform output
terraform output kubeconfig_command

# Run it (copy/paste the output, or use this):
aws eks update-kubeconfig --name techitfactory-dev --region ap-south-1
```

### Step 4.2: Verify Connection
```bash
# Check nodes
kubectl get nodes
# Should show 2 nodes in Ready state

# Check system pods
kubectl get pods -n kube-system
# Should show CoreDNS, kube-proxy, VPC-CNI, EBS-CSI pods
```

---

## Part 5: Verification

### Step 5.1: Check Cluster Status
```bash
aws eks describe-cluster --name techitfactory-dev \
  --query "cluster.{Name:name,Status:status,Version:version}" \
  --output table
```

### Step 5.2: Check Nodes
```bash
kubectl get nodes -o wide
```

### Step 5.3: Check Add-ons
```bash
aws eks list-addons --cluster-name techitfactory-dev
# Should show: vpc-cni, coredns, kube-proxy, aws-ebs-csi-driver
```

### Step 5.4: Check OIDC Provider
```bash
aws iam list-open-id-connect-providers | grep techitfactory
```

### Step 5.5: Check IRSA Roles
```bash
# These roles are ready for Helm charts to use
terraform output cluster_autoscaler_role_arn
terraform output alb_controller_role_arn
```

---

## Cost Summary

| Resource | Monthly Cost |
|----------|--------------|
| EKS Control Plane | ~$72 |
| 2x t3.medium nodes | ~$60 |
| EBS (50GB Ã— 2) | ~$10 |
| CloudWatch Logs | ~$5 |
| **Total** | **~$147/month** |

---

## Commit and Push

```bash
cd ~/Desktop/Devops-Project/techitfactory-infra
git add .
git commit -m "Enable EKS module in dev environment"
git push origin main
```

---

## Story Completion Checklist
- [ ] VPC outputs verified
- [ ] EKS module reviewed
- [ ] EKS module enabled in main.tf
- [ ] EKS outputs enabled in outputs.tf
- [ ] terraform init successful
- [ ] terraform apply successful (~15-20 min)
- [ ] kubectl configured
- [ ] Nodes showing Ready
- [ ] Add-ons installed (CoreDNS, kube-proxy, VPC CNI, EBS CSI)
- [ ] OIDC provider created
- [ ] IRSA roles created (autoscaler, ALB controller)
- [ ] Changes committed and pushed

---

## Troubleshooting

### Nodes not joining
```bash
# Check node group status
aws eks describe-nodegroup --cluster-name techitfactory-dev \
  --nodegroup-name techitfactory-dev-nodes \
  --query "nodegroup.{Status:status,Health:health}"
```

### kubectl connection issues
```bash
# Re-run kubeconfig update
aws eks update-kubeconfig --name techitfactory-dev --region ap-south-1

# Check current context
kubectl config current-context
```

---

## Next: Story 4.2 (Configure EKS Access)
