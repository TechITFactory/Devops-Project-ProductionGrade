# Sprint 3, Story 7.2: Configure App-of-Apps Pattern

## Story Summary
Set up the App-of-Apps pattern for managing all applications declaratively.

**What We're Creating:**
- Root Application (manages all apps)
- Application manifests in Git
- Environment-based deployment

---

## Prerequisites
- S7.1 completed (ArgoCD running)
- techitfactory-gitops repository created

---

## Part 1: GitOps Repository Structure

### Step 1.1: Create Repository Structure
```bash
cd ~/Desktop/Devops-Project/techitfactory-gitops

mkdir -p {apps,environments/{dev,prod},base}
```

### Step 1.2: Directory Structure
```
techitfactory-gitops/
â”œâ”€â”€ apps/                          # ArgoCD Application manifests
â”‚   â”œâ”€â”€ root-app.yaml             # Root app (App-of-Apps)
â”‚   â”œâ”€â”€ frontend.yaml
â”‚   â”œâ”€â”€ api-gateway.yaml
â”‚   â”œâ”€â”€ user-service.yaml
â”‚   â”œâ”€â”€ order-service.yaml
â”‚   â””â”€â”€ product-service.yaml
â”œâ”€â”€ environments/
â”‚   â”œâ”€â”€ dev/                       # Dev environment configs
â”‚   â”‚   â”œâ”€â”€ kustomization.yaml
â”‚   â”‚   â””â”€â”€ values/
â”‚   â””â”€â”€ prod/                      # Prod environment configs
â”‚       â”œâ”€â”€ kustomization.yaml
â”‚       â””â”€â”€ values/
â””â”€â”€ base/                          # Base Kubernetes manifests
    â”œâ”€â”€ frontend/
    â”œâ”€â”€ api-gateway/
    â””â”€â”€ ...
```

---

## Part 2: Create Root Application

### Step 2.1: Create Root App Manifest
```bash
cat > apps/root-app.yaml << 'EOF'
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: root-app
  namespace: argocd
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: default
  source:
    repoURL: https://github.com/TechITFactory/techitfactory-gitops.git
    targetRevision: main
    path: apps
  destination:
    server: https://kubernetes.default.svc
    namespace: argocd
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
EOF
```

### Step 2.2: Apply Root App
```bash
kubectl apply -f apps/root-app.yaml
```

---

## Part 3: Create Application Manifests

### Step 3.1: Frontend Application
```bash
cat > apps/frontend.yaml << 'EOF'
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: frontend
  namespace: argocd
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: default
  source:
    repoURL: https://github.com/TechITFactory/techitfactory-gitops.git
    targetRevision: main
    path: environments/dev/frontend
  destination:
    server: https://kubernetes.default.svc
    namespace: techitfactory
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
EOF
```

### Step 3.2: API Gateway Application
```bash
cat > apps/api-gateway.yaml << 'EOF'
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: api-gateway
  namespace: argocd
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: default
  source:
    repoURL: https://github.com/TechITFactory/techitfactory-gitops.git
    targetRevision: main
    path: environments/dev/api-gateway
  destination:
    server: https://kubernetes.default.svc
    namespace: techitfactory
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
EOF
```

---

## Part 4: Create Base Manifests

### Step 4.1: Frontend Base
```bash
mkdir -p base/frontend

cat > base/frontend/deployment.yaml << 'EOF'
apiVersion: apps/v1
kind: Deployment
metadata:
  name: frontend
spec:
  replicas: 2
  selector:
    matchLabels:
      app: frontend
  template:
    metadata:
      labels:
        app: frontend
    spec:
      containers:
      - name: frontend
        image: PLACEHOLDER_IMAGE
        ports:
        - containerPort: 80
        resources:
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            cpu: 500m
            memory: 256Mi
        livenessProbe:
          httpGet:
            path: /health
            port: 80
          initialDelaySeconds: 10
        readinessProbe:
          httpGet:
            path: /ready
            port: 80
          initialDelaySeconds: 5
EOF

cat > base/frontend/service.yaml << 'EOF'
apiVersion: v1
kind: Service
metadata:
  name: frontend
spec:
  selector:
    app: frontend
  ports:
  - port: 80
    targetPort: 80
EOF

cat > base/frontend/kustomization.yaml << 'EOF'
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - deployment.yaml
  - service.yaml
EOF
```

---

## Part 5: Environment Overlays

### Step 5.1: Dev Environment
```bash
mkdir -p environments/dev/frontend

cat > environments/dev/frontend/kustomization.yaml << 'EOF'
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: techitfactory

resources:
  - ../../../base/frontend

images:
  - name: PLACEHOLDER_IMAGE
    newName: <AWS_ACCOUNT>.dkr.ecr.ap-south-1.amazonaws.com/techitfactory/frontend
    newTag: latest

replicas:
  - name: frontend
    count: 2

patches:
  - patch: |-
      - op: add
        path: /spec/template/spec/containers/0/env
        value:
          - name: ENVIRONMENT
            value: dev
    target:
      kind: Deployment
      name: frontend
EOF
```

### Step 5.2: Prod Environment (Higher Replicas)
```bash
mkdir -p environments/prod/frontend

cat > environments/prod/frontend/kustomization.yaml << 'EOF'
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: techitfactory-prod

resources:
  - ../../../base/frontend

images:
  - name: PLACEHOLDER_IMAGE
    newName: <AWS_ACCOUNT>.dkr.ecr.ap-south-1.amazonaws.com/techitfactory/frontend
    newTag: v1.0.0  # Use specific version in prod

replicas:
  - name: frontend
    count: 3  # More replicas in prod

patches:
  - patch: |-
      - op: add
        path: /spec/template/spec/containers/0/env
        value:
          - name: ENVIRONMENT
            value: prod
    target:
      kind: Deployment
      name: frontend
EOF
```

---

## Part 6: Ingress Configuration

### Step 6.1: Create Ingress
```bash
cat > environments/dev/ingress.yaml << 'EOF'
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: techitfactory-ingress
  namespace: techitfactory
  annotations:
    alb.ingress.kubernetes.io/scheme: internet-facing
    alb.ingress.kubernetes.io/target-type: ip
    alb.ingress.kubernetes.io/healthcheck-path: /health
spec:
  ingressClassName: alb
  rules:
  - host: app.techitfactory.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: frontend
            port:
              number: 80
      - path: /api
        pathType: Prefix
        backend:
          service:
            name: api-gateway
            port:
              number: 80
EOF
```

---

## Part 7: Commit and Sync

### Step 7.1: Commit to Git
```bash
cd ~/Desktop/Devops-Project/techitfactory-gitops
git add .
git commit -m "Add App-of-Apps structure"
git push origin main
```

### Step 7.2: Sync in ArgoCD
```bash
# Sync root app
argocd app sync root-app

# Check all apps
argocd app list
```

---

## GitOps Workflow

```
Developer â†’ Push to techitfactory-app
                    â†“
           CI builds & pushes image to ECR
                    â†“
           CI updates image tag in techitfactory-gitops
                    â†“
           ArgoCD detects change
                    â†“
           ArgoCD syncs to cluster
```

---

## Verification

### Check Applications
```bash
argocd app list
argocd app get frontend
kubectl get pods -n techitfactory
```

### Check Sync Status
```bash
argocd app sync-status frontend
```

---

## Story Completion Checklist
- [ ] GitOps repo structure created
- [ ] Root app manifest created
- [ ] Individual app manifests created
- [ ] Base manifests with Kustomize
- [ ] Dev/Prod overlays configured
- [ ] Root app applied and syncing
- [ ] All apps visible in ArgoCD UI

---

## Epic 7 Complete! ðŸŽ‰

**What we built:**
- ArgoCD installation
- App-of-Apps pattern
- Environment-based deployments
- Automated sync with self-heal

**Next: Epic 8 (Sample Application)**
