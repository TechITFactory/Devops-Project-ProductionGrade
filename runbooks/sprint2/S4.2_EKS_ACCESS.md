# Sprint 2, Story 4.2: Configure SSO/IAM Access to EKS

## Story Summary
Configure IAM authentication for EKS cluster access.

**What We're Configuring:**
- aws-auth ConfigMap for IAM role mapping
- kubectl access for SSO users
- Read-only access for developers

---

## Prerequisites
- S4.1 completed (EKS cluster running)
- kubectl configured

---

## Part 1: Understanding EKS Authentication

### EKS Authentication Flow
```
User → AWS IAM/SSO → aws-auth ConfigMap → Kubernetes RBAC
     |                      |                    |
     Auth identity     Maps IAM→K8s user    Grants permissions
```

### Two Parts:
1. **Authentication (IAM)**: Who are you?
2. **Authorization (RBAC)**: What can you do?

---

## Part 2: View Current aws-auth ConfigMap

### Step 2.1: Check Current Configuration
```bash
kubectl get configmap aws-auth -n kube-system -o yaml
```

You'll see the node role already mapped:
```yaml
mapRoles: |
  - rolearn: arn:aws:iam::ACCOUNT:role/techitfactory-dev-node-role
    username: system:node:{{EC2PrivateDNSName}}
    groups:
      - system:bootstrappers
      - system:nodes
```

---

## Part 3: Add IAM User/Role Access

### Step 3.1: Create a Kubernetes Admin Role
```bash
cat > /tmp/k8s-admin-role.tf << 'EOF'
# Add this to your EKS module or create separate file

# IAM role that can administer the cluster
resource "aws_iam_role" "k8s_admin" {
  name = "${local.cluster_name}-k8s-admin"

  assume_role_policy = jsonencode({
    Version = "2012-10-17"
    Statement = [{
      Effect = "Allow"
      Principal = {
        AWS = "arn:aws:iam::${data.aws_caller_identity.current.account_id}:root"
      }
      Action = "sts:AssumeRole"
    }]
  })

  tags = local.common_tags
}

# Policy to allow EKS describe (for aws eks update-kubeconfig)
resource "aws_iam_role_policy" "k8s_admin" {
  name = "eks-access"
  role = aws_iam_role.k8s_admin.id

  policy = jsonencode({
    Version = "2012-10-17"
    Statement = [{
      Effect = "Allow"
      Action = [
        "eks:DescribeCluster",
        "eks:ListClusters"
      ]
      Resource = "*"
    }]
  })
}
EOF
```

### Step 3.2: Update aws-auth ConfigMap
```bash
# Add your IAM user or role to aws-auth
kubectl edit configmap aws-auth -n kube-system

# Add under mapRoles:
# - rolearn: arn:aws:iam::ACCOUNT:role/techitfactory-dev-k8s-admin
#   username: admin
#   groups:
#     - system:masters

# Or add your IAM user under mapUsers:
# - userarn: arn:aws:iam::ACCOUNT:user/jai
#   username: jai
#   groups:
#     - system:masters
```

### Step 3.3: Using eksctl (Easier Method)
```bash
# Install eksctl if not installed
# https://eksctl.io/installation/

# Add IAM user
eksctl create iamidentitymapping \
  --cluster techitfactory-dev \
  --region ap-south-1 \
  --arn arn:aws:iam::ACCOUNT:user/jai \
  --username jai \
  --group system:masters

# Add IAM role
eksctl create iamidentitymapping \
  --cluster techitfactory-dev \
  --region ap-south-1 \
  --arn arn:aws:iam::ACCOUNT:role/AdminRole \
  --username admin \
  --group system:masters
```

---

## Part 4: Create Read-Only Access for Developers

### Step 4.1: Create ClusterRole for Read-Only
```bash
cat <<EOF | kubectl apply -f -
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: developer-readonly
rules:
- apiGroups: [""]
  resources: ["pods", "services", "configmaps", "secrets", "logs"]
  verbs: ["get", "list", "watch"]
- apiGroups: ["apps"]
  resources: ["deployments", "replicasets", "statefulsets"]
  verbs: ["get", "list", "watch"]
- apiGroups: [""]
  resources: ["pods/log"]
  verbs: ["get", "list"]
EOF
```

### Step 4.2: Create ClusterRoleBinding
```bash
cat <<EOF | kubectl apply -f -
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: developer-readonly-binding
subjects:
- kind: Group
  name: developers
  apiGroup: rbac.authorization.k8s.io
roleRef:
  kind: ClusterRole
  name: developer-readonly
  apiGroup: rbac.authorization.k8s.io
EOF
```

### Step 4.3: Map Developer IAM Role to developers Group
```bash
eksctl create iamidentitymapping \
  --cluster techitfactory-dev \
  --region ap-south-1 \
  --arn arn:aws:iam::ACCOUNT:role/DeveloperRole \
  --username developer \
  --group developers
```

---

## Verification

### Test Access
```bash
# As admin
kubectl auth can-i create pods
# yes

# As developer (assume role first)
kubectl auth can-i create pods
# no

kubectl auth can-i get pods
# yes
```

### List IAM Mappings
```bash
eksctl get iamidentitymapping --cluster techitfactory-dev --region ap-south-1
```

---

## Story Completion Checklist
- [ ] aws-auth ConfigMap understood
- [ ] Admin IAM user/role added
- [ ] Developer read-only ClusterRole created
- [ ] Developer IAM role mapped
- [ ] Access verified

---

## Next: Story 4.3 (Cluster Autoscaler)
