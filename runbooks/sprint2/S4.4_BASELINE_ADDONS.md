# Sprint 2, Story 4.4: Install Baseline Add-ons

## Story Summary
Install essential Kubernetes add-ons for a production-ready cluster.

---

## Why Are We Doing This?

Your EKS cluster is running, but it's missing key features:

| Without This | You Can't... |
|--------------|--------------|
| Metrics Server | See CPU/memory usage (`kubectl top`), use HPA |
| ALB Controller | Create AWS Application Load Balancers from Ingress |
| External DNS | Auto-create Route53 DNS records |

**The Problem:**
- You want `kubectl top pods` â†’ "Error: Metrics API not available"
- You create an Ingress â†’ Nothing happens, no ALB created
- You want app.yourdomain.com â†’ Manually create DNS records every time

**The Solution:**
Install these add-ons and your cluster becomes production-ready!

---

## Runbook Overview

| Part | What We're Installing | Why You Need It |
|------|----------------------|-----------------|
| 1 | Metrics Server | `kubectl top`, HPA autoscaling |
| 2 | ALB Controller | AWS ALB from Kubernetes Ingress |
| 3 | External DNS | Auto-manage Route53 (optional) |
| 4 | Test | Prove ALB Ingress works |

---

## Part 1: Install Metrics Server

### Why Do We Need This?

**Without metrics-server:**
```bash
kubectl top nodes
# error: Metrics API not available
```

**With metrics-server:**
```bash
kubectl top nodes
# NAME                     CPU    MEMORY
# ip-10-0-10-xxx           45m    512Mi
```

**Metrics Server enables:**
1. `kubectl top nodes` - See node CPU/memory
2. `kubectl top pods` - See pod CPU/memory  
3. **HPA (Horizontal Pod Autoscaler)** - Scale pods based on CPU/memory
4. Kubernetes Dashboard metrics

### Step 1.1: Install Metrics Server
```bash
kubectl apply -f https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml
```

**What this creates:**
- Deployment in kube-system
- Service for metrics API
- APIService registration

### Step 1.2: Verify Installation
```bash
# Wait 60 seconds for metrics collection
kubectl rollout status deployment metrics-server -n kube-system

# Test it works
kubectl top nodes
kubectl top pods -A
```

---

## Part 2: Install AWS Load Balancer Controller

### Why Do We Need This?

**The Kubernetes Way:**
You define an Ingress resource (YAML) that says "I want HTTP traffic to my app"

**The AWS Way:**
You need an ALB (Application Load Balancer) in AWS

**The Problem:**
Kubernetes doesn't know how to create AWS ALBs!

**The Solution:**
AWS Load Balancer Controller watches for Ingress resources and creates real ALBs in AWS.

```
You create Ingress YAML
         â”‚
         â–¼
ALB Controller sees it
         â”‚
         â–¼
Controller calls AWS API
         â”‚
         â–¼
ALB created with target groups
         â”‚
         â–¼
Traffic flows: Internet â†’ ALB â†’ Pods
```

### Step 2.1: Add Helm Repository
```bash
helm repo add eks https://aws.github.io/eks-charts
helm repo update
```

### Step 2.2: Get IRSA Role ARN

**Why IRSA?** ALB Controller needs to:
- Create/delete ALBs
- Create/delete Target Groups
- Register/deregister targets

This requires AWS IAM permissions. IRSA lets the pod assume an IAM role securely.

```bash
cd ~/Desktop/Devops-Project/techitfactory-infra/environments/dev

ALB_ROLE_ARN=$(terraform output -raw alb_controller_role_arn)
echo "Using role: $ALB_ROLE_ARN"
```

### Step 2.3: Install Controller
```bash
helm install aws-load-balancer-controller eks/aws-load-balancer-controller \
  -n kube-system \
  --set clusterName=techitfactory-dev \
  --set serviceAccount.create=true \
  --set serviceAccount.name=aws-load-balancer-controller \
  --set serviceAccount.annotations."eks\.amazonaws\.com/role-arn"=$ALB_ROLE_ARN \
  --set region=ap-south-1 \
  --set vpcId=$(terraform output -raw vpc_id)
```

**What each flag does:**
| Flag | Why |
|------|-----|
| `clusterName` | Controller needs to know which cluster |
| `serviceAccount.annotations...` | IRSA - pod assumes IAM role |
| `region` | Which AWS region to create ALBs |
| `vpcId` | Where to create ALBs |

### Step 2.4: Verify Installation
```bash
kubectl get deployment aws-load-balancer-controller -n kube-system
# Should show 2/2 ready

kubectl logs deployment/aws-load-balancer-controller -n kube-system | head -10
# Look for: "Starting workers"
```

---

## Part 3: Install External DNS (Optional)

### Why External DNS?

**Without External DNS:**
1. You create Ingress â†’ ALB created with DNS like `k8s-xxx.elb.amazonaws.com`
2. You manually go to Route53
3. You manually create CNAME: `app.yourdomain.com` â†’ `k8s-xxx.elb.amazonaws.com`
4. Repeat for every app...

**With External DNS:**
1. You add annotation: `external-dns.alpha.kubernetes.io/hostname: app.yourdomain.com`
2. External DNS sees it
3. Automatically creates Route53 record
4. Done!

> **Skip this if you don't have a Route53 hosted zone.**

### Step 3.1: Create IRSA Role
```bash
# Create policy
cat > external-dns-policy.json << 'EOF'
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": ["route53:ChangeResourceRecordSets"],
      "Resource": ["arn:aws:route53:::hostedzone/*"]
    },
    {
      "Effect": "Allow",
      "Action": ["route53:ListHostedZones", "route53:ListResourceRecordSets"],
      "Resource": ["*"]
    }
  ]
}
EOF

aws iam create-policy \
  --policy-name ExternalDNSPolicy \
  --policy-document file://external-dns-policy.json
```

### Step 3.2: Create Service Account
```bash
eksctl create iamserviceaccount \
  --cluster=techitfactory-dev \
  --namespace=kube-system \
  --name=external-dns \
  --attach-policy-arn=arn:aws:iam::$(aws sts get-caller-identity --query Account --output text):policy/ExternalDNSPolicy \
  --approve \
  --region=ap-south-1
```

### Step 3.3: Install External DNS
```bash
helm repo add external-dns https://kubernetes-sigs.github.io/external-dns/
helm repo update

helm install external-dns external-dns/external-dns \
  -n kube-system \
  --set serviceAccount.create=false \
  --set serviceAccount.name=external-dns \
  --set provider=aws \
  --set aws.region=ap-south-1 \
  --set txtOwnerId=techitfactory-dev \
  --set domainFilters[0]=yourdomain.com  # Replace with your domain
```

---

## Part 4: Test ALB Ingress (Demo)

**Goal:** Prove that creating an Ingress actually creates an ALB!

### Step 4.1: Deploy Test Application
```bash
cat << 'EOF' | kubectl apply -f -
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-test
spec:
  replicas: 2
  selector:
    matchLabels:
      app: nginx-test
  template:
    metadata:
      labels:
        app: nginx-test
    spec:
      containers:
      - name: nginx
        image: nginx:alpine
        ports:
        - containerPort: 80
---
apiVersion: v1
kind: Service
metadata:
  name: nginx-test
spec:
  selector:
    app: nginx-test
  ports:
  - port: 80
    targetPort: 80
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: nginx-test
  annotations:
    alb.ingress.kubernetes.io/scheme: internet-facing
    alb.ingress.kubernetes.io/target-type: ip
spec:
  ingressClassName: alb
  rules:
  - http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: nginx-test
            port:
              number: 80
EOF
```

**Key annotations explained:**
| Annotation | Why |
|------------|-----|
| `scheme: internet-facing` | ALB accessible from internet (vs internal) |
| `target-type: ip` | Route directly to pod IPs (faster than instance) |

### Step 4.2: Watch ALB Get Created
```bash
# Watch for ADDRESS to populate (takes 2-3 minutes)
kubectl get ingress nginx-test -w

# Once ADDRESS shows up, test it
ALB_URL=$(kubectl get ingress nginx-test -o jsonpath='{.status.loadBalancer.ingress[0].hostname}')
echo "ALB URL: http://$ALB_URL"

# Test it works
curl http://$ALB_URL
# Should return nginx welcome page!
```

### Step 4.3: Cleanup
```bash
kubectl delete ingress nginx-test
kubectl delete service nginx-test
kubectl delete deployment nginx-test
# ALB gets deleted automatically (takes ~2 min)
```

---

## Part 5: Verification

### Check All Add-ons Are Running
```bash
echo "=== EKS Managed Add-ons ==="
aws eks list-addons --cluster-name techitfactory-dev --output table

echo -e "\n=== Metrics Server ==="
kubectl get deployment metrics-server -n kube-system
kubectl top nodes

echo -e "\n=== ALB Controller ==="
kubectl get deployment aws-load-balancer-controller -n kube-system

echo -e "\n=== Cluster Autoscaler ==="
kubectl get deployment cluster-autoscaler -n kube-system
```

---

## Add-on Summary

| Add-on | What It Does | Installed |
|--------|--------------|-----------|
| CoreDNS | Cluster DNS resolution | âœ… EKS Managed |
| kube-proxy | Network proxy | âœ… EKS Managed |
| VPC CNI | Pod networking | âœ… EKS Managed |
| EBS CSI | Persistent volumes | âœ… EKS Managed |
| Metrics Server | kubectl top, HPA | âœ… Manual |
| Cluster Autoscaler | Node autoscaling | âœ… Manual (S4.3) |
| ALB Controller | AWS ALB from Ingress | âœ… Manual |
| External DNS | Route53 automation | Optional |

---

## Troubleshooting

### "ALB not being created"
```bash
# Check controller logs
kubectl logs deployment/aws-load-balancer-controller -n kube-system | grep -i error

# Check IRSA is working
kubectl describe sa aws-load-balancer-controller -n kube-system | grep Annotations

# Check public subnets have ELB tag
aws ec2 describe-subnets --filters "Name=tag:kubernetes.io/role/elb,Values=1" --query "Subnets[*].SubnetId"
```

### "Metrics not available"
```bash
# Wait 1-2 minutes after install
# Check metrics-server logs
kubectl logs deployment/metrics-server -n kube-system
```

---

## Key Takeaways

1. **Metrics Server unlocks HPA** - Can't autoscale pods without metrics
2. **ALB Controller uses IRSA** - Secure way to call AWS APIs
3. **Ingress annotations control ALB** - scheme, target-type, etc.
4. **External DNS is optional** - Only if you have Route53 domain

---

## Epic 4 Complete! ðŸŽ‰

**What we built in Epic 4:**
| Story | What |
|-------|------|
| S4.1 | EKS cluster with managed nodes |
| S4.2 | SSO access with RBAC |
| S4.3 | Cluster Autoscaler |
| S4.4 | Metrics + ALB Controller |

**Your cluster now has:**
- âœ… Nodes that scale based on demand
- âœ… Pods that can autoscale (HPA ready)
- âœ… Ingress that creates real ALBs
- âœ… Multiple access levels for team members

**Next: Epic 5 (CI/CD Pipeline)**
