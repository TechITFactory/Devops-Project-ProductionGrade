# Sprint 2, Story 5.1: Install AWS Load Balancer Controller

## Story Summary
Deploy AWS Load Balancer Controller to provision ALB/NLB via Kubernetes Ingress resources.

**What We're Installing:**
- AWS Load Balancer Controller
- IRSA role for controller
- IngressClass configuration

---

## Prerequisites
- S4.1 completed (EKS cluster running)
- kubectl configured
- Helm installed

---

## Part 1: Create IRSA Role for ALB Controller

### Step 1.1: Add ALB Controller IRSA to Terraform

Add to `modules/eks/main.tf` or create `modules/alb-controller/`:
```hcl
# ALB Controller IAM Policy
data "http" "alb_controller_policy" {
  url = "https://raw.githubusercontent.com/kubernetes-sigs/aws-load-balancer-controller/main/docs/install/iam_policy.json"
}

resource "aws_iam_policy" "alb_controller" {
  name   = "${local.cluster_name}-alb-controller"
  policy = data.http.alb_controller_policy.response_body
}

resource "aws_iam_role" "alb_controller" {
  name = "${local.cluster_name}-alb-controller"

  assume_role_policy = jsonencode({
    Version = "2012-10-17"
    Statement = [{
      Effect = "Allow"
      Principal = {
        Federated = aws_iam_openid_connect_provider.cluster.arn
      }
      Action = "sts:AssumeRoleWithWebIdentity"
      Condition = {
        StringEquals = {
          "${local.oidc_issuer}:aud" = "sts.amazonaws.com"
          "${local.oidc_issuer}:sub" = "system:serviceaccount:kube-system:aws-load-balancer-controller"
        }
      }
    }]
  })
}

resource "aws_iam_role_policy_attachment" "alb_controller" {
  policy_arn = aws_iam_policy.alb_controller.arn
  role       = aws_iam_role.alb_controller.name
}
```

### Step 1.2: Apply Terraform
```bash
cd ~/Desktop/Devops-Project/techitfactory-infra/environments/dev
terraform apply
```

---

## Part 2: Install ALB Controller via Helm

### Step 2.1: Add Helm Repo
```bash
helm repo add eks https://aws.github.io/eks-charts
helm repo update eks
```

### Step 2.2: Create Service Account
```bash
# Get the role ARN from Terraform output
ALB_ROLE_ARN=$(terraform output -raw alb_controller_role_arn)

kubectl apply -f - <<EOF
apiVersion: v1
kind: ServiceAccount
metadata:
  name: aws-load-balancer-controller
  namespace: kube-system
  annotations:
    eks.amazonaws.com/role-arn: ${ALB_ROLE_ARN}
EOF
```

### Step 2.3: Install Controller
```bash
helm install aws-load-balancer-controller eks/aws-load-balancer-controller \
  -n kube-system \
  --set clusterName=techitfactory-dev \
  --set serviceAccount.create=false \
  --set serviceAccount.name=aws-load-balancer-controller \
  --set region=ap-south-1 \
  --set vpcId=$(terraform output -raw vpc_id)
```

### Step 2.4: Verify Installation
```bash
kubectl get deployment aws-load-balancer-controller -n kube-system
kubectl logs -f deployment/aws-load-balancer-controller -n kube-system
```

---

## Part 3: Create IngressClass

### Step 3.1: Create Default IngressClass
```bash
kubectl apply -f - <<EOF
apiVersion: networking.k8s.io/v1
kind: IngressClass
metadata:
  name: alb
  annotations:
    ingressclass.kubernetes.io/is-default-class: "true"
spec:
  controller: ingress.k8s.aws/alb
EOF
```

---

## Part 4: Test ALB Ingress

### Step 4.1: Deploy Sample Application
```bash
kubectl apply -f - <<EOF
apiVersion: apps/v1
kind: Deployment
metadata:
  name: hello-app
  namespace: default
spec:
  replicas: 2
  selector:
    matchLabels:
      app: hello-app
  template:
    metadata:
      labels:
        app: hello-app
    spec:
      containers:
      - name: hello
        image: hashicorp/http-echo
        args: ["-text=Hello from TechITFactory!"]
        ports:
        - containerPort: 5678
---
apiVersion: v1
kind: Service
metadata:
  name: hello-app
  namespace: default
spec:
  selector:
    app: hello-app
  ports:
  - port: 80
    targetPort: 5678
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: hello-app
  namespace: default
  annotations:
    alb.ingress.kubernetes.io/scheme: internet-facing
    alb.ingress.kubernetes.io/target-type: ip
    alb.ingress.kubernetes.io/healthcheck-path: /
spec:
  ingressClassName: alb
  rules:
  - http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: hello-app
            port:
              number: 80
EOF
```

### Step 4.2: Get ALB URL
```bash
# Wait ~2 minutes for ALB provisioning
kubectl get ingress hello-app

# Test
ALB_URL=$(kubectl get ingress hello-app -o jsonpath='{.status.loadBalancer.ingress[0].hostname}')
curl http://${ALB_URL}
# Should return: Hello from TechITFactory!
```

### Step 4.3: Cleanup Test
```bash
kubectl delete ingress hello-app
kubectl delete service hello-app
kubectl delete deployment hello-app
```

---

## Verification

### Check Controller
```bash
kubectl get pods -n kube-system | grep aws-load-balancer
kubectl logs deployment/aws-load-balancer-controller -n kube-system | tail -20
```

### Check IngressClass
```bash
kubectl get ingressclass
```

---

## Annotations Reference

| Annotation | Description | Example |
|------------|-------------|---------|
| `alb.ingress.kubernetes.io/scheme` | internet-facing or internal | `internet-facing` |
| `alb.ingress.kubernetes.io/target-type` | ip or instance | `ip` |
| `alb.ingress.kubernetes.io/certificate-arn` | ACM cert ARN | `arn:aws:acm:...` |
| `alb.ingress.kubernetes.io/listen-ports` | Port configuration | `'[{"HTTPS":443}]'` |
| `alb.ingress.kubernetes.io/ssl-redirect` | Force HTTPS | `'443'` |

---

## Story Completion Checklist
- [ ] IRSA role for ALB Controller created
- [ ] Helm repo added
- [ ] ALB Controller installed
- [ ] IngressClass created
- [ ] Test Ingress creates ALB
- [ ] ALB accessible from internet

---

## Next: Story 5.2 (Route53 + TLS)
