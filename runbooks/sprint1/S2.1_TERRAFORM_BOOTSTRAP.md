# Sprint 1, Story 2.1: Build Bootstrap Stack (S3 + DynamoDB + KMS)

## Story Summary
Create Terraform remote state backend with S3 bucket, DynamoDB lock table, and KMS encryption.

**Why:** Two engineers running `terraform apply` simultaneously can corrupt state. Remote state with locking prevents this.

---

## Prerequisites
- AWS CLI configured with admin access
- Terraform installed (1.6+)
- techitfactory-infra repo cloned

---

## Part 1: Create Bootstrap Terraform

### Step 1.1: Navigate to Bootstrap Directory
```bash
cd ~/techitfactory/techitfactory-infra
# Or your path to the infra repo
```

### Step 1.2: Create Bootstrap Variables
```bash
cat > bootstrap/variables.tf << 'EOF'
variable "project_name" {
  description = "Project name for resource naming"
  type        = string
  default     = "techitfactory"
}

variable "environment" {
  description = "Environment name"
  type        = string
  default     = "shared"
}

variable "aws_region" {
  description = "AWS region"
  type        = string
  default     = "ap-south-1"
}

variable "tags" {
  description = "Common tags for all resources"
  type        = map(string)
  default = {
    Project   = "TechITFactory"
    ManagedBy = "Terraform"
    Purpose   = "DevOps Course"
  }
}
EOF
```

### Step 1.3: Create Bootstrap Main Configuration
```bash
cat > bootstrap/main.tf << 'EOF'
# Terraform Bootstrap - Remote State Infrastructure
# This creates the S3 bucket, DynamoDB table, and KMS key for state management

terraform {
  required_version = ">= 1.6.0"

  required_providers {
    aws = {
      source  = "hashicorp/aws"
      version = "~> 5.0"
    }
  }
}

provider "aws" {
  region = var.aws_region

  default_tags {
    tags = var.tags
  }
}

# Random suffix for globally unique bucket name
resource "random_id" "bucket_suffix" {
  byte_length = 4
}

locals {
  bucket_name = "${var.project_name}-tfstate-${random_id.bucket_suffix.hex}"
  table_name  = "${var.project_name}-tflock"
}

# KMS Key for encrypting state
resource "aws_kms_key" "terraform_state" {
  description             = "KMS key for Terraform state encryption"
  deletion_window_in_days = 7
  enable_key_rotation     = true

  tags = {
    Name = "${var.project_name}-tfstate-key"
  }
}

resource "aws_kms_alias" "terraform_state" {
  name          = "alias/${var.project_name}-tfstate"
  target_key_id = aws_kms_key.terraform_state.key_id
}

# S3 Bucket for Terraform State
resource "aws_s3_bucket" "terraform_state" {
  bucket = local.bucket_name

  # Prevent accidental deletion
  lifecycle {
    prevent_destroy = false  # Set to true in production
  }

  tags = {
    Name = local.bucket_name
  }
}

resource "aws_s3_bucket_versioning" "terraform_state" {
  bucket = aws_s3_bucket.terraform_state.id

  versioning_configuration {
    status = "Enabled"
  }
}

resource "aws_s3_bucket_server_side_encryption_configuration" "terraform_state" {
  bucket = aws_s3_bucket.terraform_state.id

  rule {
    apply_server_side_encryption_by_default {
      kms_master_key_id = aws_kms_key.terraform_state.arn
      sse_algorithm     = "aws:kms"
    }
    bucket_key_enabled = true
  }
}

resource "aws_s3_bucket_public_access_block" "terraform_state" {
  bucket = aws_s3_bucket.terraform_state.id

  block_public_acls       = true
  block_public_policy     = true
  ignore_public_acls      = true
  restrict_public_buckets = true
}

# DynamoDB Table for State Locking
resource "aws_dynamodb_table" "terraform_lock" {
  name         = local.table_name
  billing_mode = "PAY_PER_REQUEST"
  hash_key     = "LockID"

  attribute {
    name = "LockID"
    type = "S"
  }

  tags = {
    Name = local.table_name
  }
}
EOF
```

### Step 1.4: Create Bootstrap Outputs
```bash
cat > bootstrap/outputs.tf << 'EOF'
output "state_bucket_name" {
  description = "S3 bucket for Terraform state"
  value       = aws_s3_bucket.terraform_state.id
}

output "state_bucket_arn" {
  description = "S3 bucket ARN"
  value       = aws_s3_bucket.terraform_state.arn
}

output "lock_table_name" {
  description = "DynamoDB table for state locking"
  value       = aws_dynamodb_table.terraform_lock.name
}

output "kms_key_arn" {
  description = "KMS key ARN for state encryption"
  value       = aws_kms_key.terraform_state.arn
}

output "kms_key_alias" {
  description = "KMS key alias"
  value       = aws_kms_alias.terraform_state.name
}

output "backend_config" {
  description = "Backend configuration for other Terraform configs"
  value = <<-EOT
    terraform {
      backend "s3" {
        bucket         = "${aws_s3_bucket.terraform_state.id}"
        key            = "path/to/terraform.tfstate"
        region         = "${var.aws_region}"
        encrypt        = true
        kms_key_id     = "${aws_kms_key.terraform_state.arn}"
        dynamodb_table = "${aws_dynamodb_table.terraform_lock.name}"
      }
    }
  EOT
}
EOF
```

---

## Part 2: Deploy Bootstrap

### Step 2.1: Initialize Terraform
```bash
cd bootstrap
terraform init
```

### Step 2.2: Review Plan
```bash
terraform plan
# Review: Should create ~7 resources
# - KMS key + alias
# - S3 bucket + versioning + encryption + public access block
# - DynamoDB table
```

### Step 2.3: Apply Bootstrap
```bash
terraform apply
# Type 'yes' when prompted
```

### Step 2.4: Save Outputs
```bash
# Save the outputs for reference
terraform output > ../BOOTSTRAP_OUTPUTS.txt
cat ../BOOTSTRAP_OUTPUTS.txt

# Note the bucket name and table name - you'll need these!
```

---

## Part 3: Create Backend Config Template

### Step 3.1: Create Backend Template for Modules
```bash
cat > ../backend.tf.example << 'EOF'
# Copy this file as backend.tf in environments/dev or environments/prod
# Replace <BUCKET_NAME> and <DYNAMODB_TABLE> with outputs from bootstrap

terraform {
  backend "s3" {
    bucket         = "<BUCKET_NAME>"
    key            = "environments/dev/terraform.tfstate"  # Change per environment
    region         = "ap-south-1"
    encrypt        = true
    dynamodb_table = "<DYNAMODB_TABLE>"
  }
}
EOF
```

---

## Part 4: Commit and Push

### Step 4.1: Stage and Commit
```bash
cd ~/techitfactory/techitfactory-infra
git checkout -b feature/bootstrap-stack

git add bootstrap/
git add backend.tf.example
git add BOOTSTRAP_OUTPUTS.txt

git commit -m "Add Terraform bootstrap stack for remote state"
```

### Step 4.2: Push and Create PR
```bash
git push origin feature/bootstrap-stack

# Create PR via GitHub CLI or UI
gh pr create --title "Epic 2: Add Terraform bootstrap stack" \
  --body "Creates S3 bucket, DynamoDB lock table, and KMS key for Terraform remote state management."
```

### Step 4.3: Merge PR
```bash
# After review (or self-merge if bypass enabled)
gh pr merge --squash
git checkout main
git pull
```

---

## Verification

### Check AWS Resources Created
```bash
# List S3 buckets
aws s3 ls | grep techitfactory

# Check DynamoDB table
aws dynamodb describe-table --table-name techitfactory-tflock

# Check KMS key
aws kms list-aliases | grep techitfactory
```

### Test State Locking
```bash
cd bootstrap
# Run plan in two terminals simultaneously to verify locking
terraform plan
# Second terminal should wait for lock
```

---

## Destroy (Optional - for testing)
```bash
cd bootstrap
terraform destroy
# Type 'yes' when prompted
# WARNING: This deletes all state management infrastructure!
```

---

## Story Completion Checklist
- [ ] bootstrap/variables.tf created
- [ ] bootstrap/main.tf created (S3 + DynamoDB + KMS)
- [ ] bootstrap/outputs.tf created
- [ ] terraform init successful
- [ ] terraform apply successful
- [ ] S3 bucket exists with versioning
- [ ] DynamoDB table exists
- [ ] KMS key exists
- [ ] backend.tf.example created
- [ ] Changes committed and pushed
