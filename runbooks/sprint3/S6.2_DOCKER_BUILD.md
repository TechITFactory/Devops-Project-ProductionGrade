# Sprint 3, Story 6.2: Build and Push Docker Images

## Story Summary
Create Dockerfiles for microservices and push images to ECR.

**What We're Building:**
- Multi-stage Dockerfiles for each service
- GitHub Actions workflow for CI/CD
- Image tagging strategy

---

## Prerequisites
- S6.1 completed (ECR repositories exist)
- Docker installed locally
- GitHub Actions configured

---

## Part 1: Dockerfile Best Practices

### Multi-Stage Build Pattern
```dockerfile
# Stage 1: Build
FROM node:20-alpine AS builder
WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production
COPY . .
RUN npm run build

# Stage 2: Production
FROM node:20-alpine AS production
WORKDIR /app
RUN addgroup -g 1001 -S nodejs && adduser -S nodejs -u 1001
COPY --from=builder --chown=nodejs:nodejs /app/dist ./dist
COPY --from=builder --chown=nodejs:nodejs /app/node_modules ./node_modules
USER nodejs
EXPOSE 3000
CMD ["node", "dist/main.js"]
```

### Key Principles
1. **Multi-stage builds** - smaller final image
2. **Non-root user** - security best practice
3. **Specific base image tags** - reproducibility
4. **.dockerignore** - exclude unnecessary files

---

## Part 2: Sample Dockerfiles

### Node.js Service
```bash
cat > services/api-gateway/Dockerfile << 'EOF'
# syntax=docker/dockerfile:1
FROM node:20-alpine AS builder
WORKDIR /app
COPY package*.json ./
RUN npm ci
COPY . .
RUN npm run build

FROM node:20-alpine AS production
ENV NODE_ENV=production
WORKDIR /app
RUN addgroup -g 1001 -S appgroup && adduser -S appuser -u 1001 -G appgroup
COPY --from=builder --chown=appuser:appgroup /app/dist ./dist
COPY --from=builder --chown=appuser:appgroup /app/node_modules ./node_modules
COPY --from=builder --chown=appuser:appgroup /app/package.json ./
USER appuser
EXPOSE 3000
HEALTHCHECK --interval=30s --timeout=3s CMD wget -q --spider http://localhost:3000/health || exit 1
CMD ["node", "dist/main.js"]
EOF
```

### Go Service
```bash
cat > services/order-service/Dockerfile << 'EOF'
# syntax=docker/dockerfile:1
FROM golang:1.21-alpine AS builder
WORKDIR /app
COPY go.mod go.sum ./
RUN go mod download
COPY . .
RUN CGO_ENABLED=0 GOOS=linux go build -ldflags="-w -s" -o main .

FROM gcr.io/distroless/static-debian12 AS production
COPY --from=builder /app/main /
EXPOSE 8080
USER nonroot:nonroot
ENTRYPOINT ["/main"]
EOF
```

### Python Service
```bash
cat > services/product-service/Dockerfile << 'EOF'
# syntax=docker/dockerfile:1
FROM python:3.11-slim AS builder
WORKDIR /app
RUN pip install poetry
COPY pyproject.toml poetry.lock ./
RUN poetry export -f requirements.txt --output requirements.txt
COPY . .

FROM python:3.11-slim AS production
WORKDIR /app
RUN useradd -r -s /bin/false appuser
COPY --from=builder /app/requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt
COPY --from=builder --chown=appuser:appuser /app .
USER appuser
EXPOSE 8000
HEALTHCHECK --interval=30s --timeout=3s CMD curl -f http://localhost:8000/health || exit 1
CMD ["gunicorn", "-w", "4", "-b", "0.0.0.0:8000", "app:app"]
EOF
```

---

## Part 3: Local Build and Push

### Step 3.1: Build Images
```bash
# Set variables
AWS_ACCOUNT=$(aws sts get-caller-identity --query Account --output text)
AWS_REGION=ap-south-1
ECR_REGISTRY=${AWS_ACCOUNT}.dkr.ecr.${AWS_REGION}.amazonaws.com

# Build each service
docker build -t techitfactory/api-gateway:latest services/api-gateway/
docker build -t techitfactory/user-service:latest services/user-service/
```

### Step 3.2: Tag for ECR
```bash
# Tag with ECR registry
docker tag techitfactory/api-gateway:latest ${ECR_REGISTRY}/techitfactory/api-gateway:latest
docker tag techitfactory/api-gateway:latest ${ECR_REGISTRY}/techitfactory/api-gateway:v1.0.0
```

### Step 3.3: Login and Push
```bash
# Login to ECR
aws ecr get-login-password --region ${AWS_REGION} | \
  docker login --username AWS --password-stdin ${ECR_REGISTRY}

# Push images
docker push ${ECR_REGISTRY}/techitfactory/api-gateway:latest
docker push ${ECR_REGISTRY}/techitfactory/api-gateway:v1.0.0
```

---

## Part 4: GitHub Actions CI/CD

### Step 4.1: Create Workflow
```bash
cat > .github/workflows/docker-build.yml << 'EOF'
name: Docker Build and Push

on:
  push:
    branches: [main]
    paths:
      - 'services/**'
  pull_request:
    branches: [main]
    paths:
      - 'services/**'

env:
  AWS_REGION: ap-south-1

permissions:
  id-token: write
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service:
          - api-gateway
          - user-service
          - order-service
          - product-service
          - frontend
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and Push
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          cd services/${{ matrix.service }}
          docker build -t $ECR_REGISTRY/techitfactory/${{ matrix.service }}:$IMAGE_TAG .
          docker tag $ECR_REGISTRY/techitfactory/${{ matrix.service }}:$IMAGE_TAG \
                     $ECR_REGISTRY/techitfactory/${{ matrix.service }}:latest
          docker push $ECR_REGISTRY/techitfactory/${{ matrix.service }}:$IMAGE_TAG
          docker push $ECR_REGISTRY/techitfactory/${{ matrix.service }}:latest
EOF
```

---

## Part 5: Image Tagging Strategy

| Tag | Purpose | Example |
|-----|---------|---------|
| `latest` | Most recent build | Auto-updated |
| `v1.0.0` | Semantic version | Manual release |
| `main-abc123` | Branch + commit | CI builds |
| `pr-42` | Pull request | PR builds |

---

## Verification

### Check Images in ECR
```bash
aws ecr describe-images \
  --repository-name techitfactory/api-gateway \
  --query 'imageDetails[*].{Tags:imageTags,Size:imageSizeInBytes,Pushed:imagePushedAt}' \
  --output table
```

### Pull and Run Locally
```bash
docker pull ${ECR_REGISTRY}/techitfactory/api-gateway:latest
docker run -p 3000:3000 ${ECR_REGISTRY}/techitfactory/api-gateway:latest
```

---

## Security Scanning

### Check Scan Results
```bash
aws ecr describe-image-scan-findings \
  --repository-name techitfactory/api-gateway \
  --image-id imageTag=latest
```

### Trivy Local Scan
```bash
trivy image ${ECR_REGISTRY}/techitfactory/api-gateway:latest
```

---

## Story Completion Checklist
- [ ] Dockerfiles created for all services
- [ ] Multi-stage builds implemented
- [ ] .dockerignore files created
- [ ] Local build works
- [ ] Push to ECR works
- [ ] GitHub Actions workflow created
- [ ] CI builds trigger on push
- [ ] Image scanning enabled
- [ ] Security findings reviewed

---

## Next: Epic 7 (GitOps Setup)
