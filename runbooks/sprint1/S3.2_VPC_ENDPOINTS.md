# Sprint 1, Story 3.2: Add VPC Endpoints

## Story Summary
Add additional VPC endpoints to reduce NAT Gateway costs and improve security.

**What We're Adding:**
- ECR API Endpoint (Interface)
- ECR DKR Endpoint (Interface)
- CloudWatch Logs Endpoint (Interface)
- STS Endpoint (Interface - for IRSA)

---

## Prerequisites
- S3.1 completed (VPC provisioned)
- VPC ID available

---

## Part 0: Verify Prerequisites

### Step 0.1: Verify VPC is Deployed
```bash
cd ~/Desktop/Devops-Project/techitfactory-infra/environments/dev

# Get VPC ID
terraform output vpc_id
# Should return: vpc-xxxxxxxxx

# If you get an error, go back and complete S3.1 first!
```

### Step 0.2: Note VPC ID
```bash
# Save the VPC ID - you'll need it for verification
export VPC_ID=$(terraform output -raw vpc_id)
echo "VPC ID: $VPC_ID"
```

---

## Part 1: Understanding VPC Endpoints

### Gateway vs Interface Endpoints

| Type | Examples | Cost | Notes |
|------|----------|------|-------|
| Gateway | S3, DynamoDB | FREE | Uses route tables |
| Interface | ECR, CW, STS | ~$7.50/month each | Uses ENIs + PrivateLink |

### Why These Endpoints?

| Endpoint | Purpose | Without It |
|----------|---------|------------|
| ECR API | Pull image manifests | Goes through NAT ($) |
| ECR DKR | Pull image layers | Goes through NAT ($$$) |
| STS | IRSA token exchange | Goes through NAT |
| CW Logs | Container logs | Goes through NAT |

---

## Part 2: Add Endpoints to VPC Module

### Step 2.1: Navigate to VPC Module
```bash
cd ~/Desktop/Devops-Project/techitfactory-infra/modules/vpc

# Confirm you're in the right directory
pwd
# Should show: .../techitfactory-infra/modules/vpc
```

### Step 2.2: Update variables.tf

# Add these variables to variables.tf
cat >> variables.tf << 'EOF'

# -----------------------------------------------------------------------------
# INTERFACE ENDPOINTS (Cost: ~$7.50/month each)
# -----------------------------------------------------------------------------

variable "enable_ecr_endpoints" {
  description = "Enable ECR VPC endpoints (reduces NAT costs for image pulls)"
  type        = bool
  default     = false  # Enable when EKS is ready

  # COST vs SAVINGS:
  # - ECR endpoints: ~$15/month (2 endpoints)
  # - NAT data transfer: ~$0.045/GB
  # - If pulling >330GB/month of images, endpoints save money
}

variable "enable_logs_endpoint" {
  description = "Enable CloudWatch Logs endpoint"
  type        = bool
  default     = false

  # Useful for container logs going to CloudWatch
}

variable "enable_sts_endpoint" {
  description = "Enable STS endpoint (for IRSA)"
  type        = bool
  default     = false

  # Required for IRSA token exchange to stay private
}
EOF
```

### Step 2.3: Add Security Group for Endpoints
```bash
# Append to main.tf
cat >> main.tf << 'EOF'

# =============================================================================
# SECURITY GROUP FOR VPC ENDPOINTS
# =============================================================================

resource "aws_security_group" "vpc_endpoints" {
  count = (var.enable_ecr_endpoints || var.enable_logs_endpoint || var.enable_sts_endpoint) ? 1 : 0

  name        = "${local.name}-vpc-endpoints-sg"
  description = "Security group for VPC endpoints"
  vpc_id      = aws_vpc.main.id

  ingress {
    description = "HTTPS from VPC"
    from_port   = 443
    to_port     = 443
    protocol    = "tcp"
    cidr_blocks = [aws_vpc.main.cidr_block]
  }

  egress {
    from_port   = 0
    to_port     = 0
    protocol    = "-1"
    cidr_blocks = ["0.0.0.0/0"]
  }

  tags = merge(local.common_tags, {
    Name = "${local.name}-vpc-endpoints-sg"
  })
}

# =============================================================================
# ECR API ENDPOINT
# =============================================================================

resource "aws_vpc_endpoint" "ecr_api" {
  count = var.enable_ecr_endpoints ? 1 : 0

  vpc_id              = aws_vpc.main.id
  service_name        = "com.amazonaws.${data.aws_region.current.name}.ecr.api"
  vpc_endpoint_type   = "Interface"
  subnet_ids          = aws_subnet.private[*].id
  security_group_ids  = [aws_security_group.vpc_endpoints[0].id]
  private_dns_enabled = true

  tags = merge(local.common_tags, {
    Name = "${local.name}-ecr-api-endpoint"
  })
}

# =============================================================================
# ECR DKR ENDPOINT (Docker Registry)
# =============================================================================

resource "aws_vpc_endpoint" "ecr_dkr" {
  count = var.enable_ecr_endpoints ? 1 : 0

  vpc_id              = aws_vpc.main.id
  service_name        = "com.amazonaws.${data.aws_region.current.name}.ecr.dkr"
  vpc_endpoint_type   = "Interface"
  subnet_ids          = aws_subnet.private[*].id
  security_group_ids  = [aws_security_group.vpc_endpoints[0].id]
  private_dns_enabled = true

  tags = merge(local.common_tags, {
    Name = "${local.name}-ecr-dkr-endpoint"
  })
}

# =============================================================================
# CLOUDWATCH LOGS ENDPOINT
# =============================================================================

resource "aws_vpc_endpoint" "logs" {
  count = var.enable_logs_endpoint ? 1 : 0

  vpc_id              = aws_vpc.main.id
  service_name        = "com.amazonaws.${data.aws_region.current.name}.logs"
  vpc_endpoint_type   = "Interface"
  subnet_ids          = aws_subnet.private[*].id
  security_group_ids  = [aws_security_group.vpc_endpoints[0].id]
  private_dns_enabled = true

  tags = merge(local.common_tags, {
    Name = "${local.name}-logs-endpoint"
  })
}

# =============================================================================
# STS ENDPOINT (for IRSA)
# =============================================================================

resource "aws_vpc_endpoint" "sts" {
  count = var.enable_sts_endpoint ? 1 : 0

  vpc_id              = aws_vpc.main.id
  service_name        = "com.amazonaws.${data.aws_region.current.name}.sts"
  vpc_endpoint_type   = "Interface"
  subnet_ids          = aws_subnet.private[*].id
  security_group_ids  = [aws_security_group.vpc_endpoints[0].id]
  private_dns_enabled = true

  tags = merge(local.common_tags, {
    Name = "${local.name}-sts-endpoint"
  })
}
EOF
```

### Step 2.4: Add Endpoint Outputs
```bash
# Append to outputs.tf
cat >> outputs.tf << 'EOF'

# -----------------------------------------------------------------------------
# VPC ENDPOINTS
# -----------------------------------------------------------------------------

output "s3_endpoint_id" {
  description = "S3 VPC Endpoint ID"
  value       = var.enable_s3_endpoint ? aws_vpc_endpoint.s3[0].id : null
}

output "vpc_endpoint_sg_id" {
  description = "Security group ID for VPC endpoints"
  value       = length(aws_security_group.vpc_endpoints) > 0 ? aws_security_group.vpc_endpoints[0].id : null
}
EOF
```

---

## Part 3: Enable Endpoints in Dev Environment

### Step 3.1: Navigate to Dev Environment
```bash
cd ~/Desktop/Devops-Project/techitfactory-infra/environments/dev

# Confirm you're in the right directory
pwd
```

### Step 3.2: Update main.tf to Enable Endpoints
```bash
# View current VPC module configuration
cat main.tf | grep -A 20 "module \"vpc\""

# Now, update main.tf to add endpoint parameters
# Replace the VPC module block with this updated version:
cat > main.tf << 'EOF'
# =============================================================================
# Dev Environment - Main Configuration
# =============================================================================

terraform {
  required_version = ">= 1.6.0"

  required_providers {
    aws = {
      source  = "hashicorp/aws"
      version = "~> 5.0"
    }
  }
}

provider "aws" {
  region = "ap-south-1"

  default_tags {
    tags = {
      Environment = "dev"
      Project     = "TechITFactory"
      ManagedBy   = "Terraform"
    }
  }
}

# =============================================================================
# VPC MODULE
# =============================================================================

module "vpc" {
  source = "../../modules/vpc"

  project_name       = "techitfactory"
  environment        = "dev"
  vpc_cidr           = "10.0.0.0/16"
  azs                = ["ap-south-1a", "ap-south-1b"]
  public_subnets     = ["10.0.1.0/24", "10.0.2.0/24"]
  private_subnets    = ["10.0.10.0/24", "10.0.20.0/24"]
  single_nat_gateway = true   # Cost optimization for dev
  enable_s3_endpoint = true   # FREE - always enable
  
  # OPTIONAL: Interface endpoints (cost ~$7.50/month each)
  # Uncomment these for production or when EKS is ready:
  # enable_ecr_endpoints = true
  # enable_logs_endpoint = true
  # enable_sts_endpoint  = true
}
EOF
```

> **Note:** For dev/learning, we keep interface endpoints DISABLED to save ~$30/month. The S3 Gateway endpoint is FREE and provides the biggest cost savings.

### Step 3.3: Plan and Apply Changes
```bash
# Plan first - should show minimal changes (just updating module parameters)
terraform plan

# Apply if plan looks good
terraform apply
```

### Step 3.4: (OPTIONAL) Enable Interface Endpoints
```bash
# Only if you want to enable interface endpoints:
# Edit main.tf and uncomment the endpoint lines:
nano main.tf

# Then apply
terraform plan
# Should show 4-5 new resources:
# - 1 Security Group
# - 2 ECR endpoints (api + dkr)
# - 1 Logs endpoint  
# - 1 STS endpoint

terraform apply
```

---

## Verification

### Check VPC Endpoints
```bash
aws ec2 describe-vpc-endpoints --filters "Name=vpc-id,Values=<vpc-id>" \
  --query "VpcEndpoints[*].{ID:VpcEndpointId,Service:ServiceName,Type:VpcEndpointType,State:State}"
```

### Test ECR Connectivity (after EKS is ready)
```bash
# From a pod in the cluster
nslookup ecr.ap-south-1.amazonaws.com
# Should resolve to private IP
```

---

## Cost Summary

| Endpoint | Type | Monthly Cost |
|----------|------|--------------|
| S3 | Gateway | FREE |
| ECR API | Interface | ~$7.50 |
| ECR DKR | Interface | ~$7.50 |
| CloudWatch Logs | Interface | ~$7.50 |
| STS | Interface | ~$7.50 |
| **Total** | | **~$30/month** |

**Note:** For dev/learning, you can skip interface endpoints initially. S3 Gateway endpoint is FREE and saves the most money (ECR layers are stored in S3).

---

## Commit and Push

```bash
cd ~/Desktop/Devops-Project/techitfactory-infra
git add modules/vpc/
git commit -m "Add VPC interface endpoints for ECR, Logs, STS"
git push origin main
```

---

## Story Completion Checklist
- [ ] variables.tf updated with endpoint toggles
- [ ] Security group created for endpoints
- [ ] ECR endpoints added (optional)
- [ ] Logs endpoint added (optional)
- [ ] STS endpoint added (optional)
- [ ] S3 gateway endpoint verified
- [ ] Changes committed and pushed

---

## Recommendation for Course

**For learning/cost savings:**
1. Always enable S3 Gateway endpoint (FREE)
2. Skip Interface endpoints initially
3. Add them when you notice high NAT costs

**For production:**
1. Enable all endpoints
2. The $30/month cost is worth it for:
   - Reduced NAT data transfer costs
   - Better security (traffic stays in AWS network)
   - Lower latency
