# Sprint 1, Story 2.2: Configure GitHub OIDC for AWS

## Story Summary
Configure GitHub Actions to authenticate with AWS using OIDC (OpenID Connect) â€” no static AWS keys needed.

**Why:** Static AWS access keys in GitHub Secrets are a security risk. OIDC provides short-lived credentials.

---

## Prerequisites
- AWS CLI configured with admin access
- Bootstrap completed (S2.1)
- GitHub repo: techitfactory-infra

---

## Part 1: Create OIDC Provider in AWS

### Step 1.1: Create OIDC Terraform Configuration
```bash
cd ~/techitfactory/techitfactory-infra

cat > bootstrap/github-oidc.tf << 'EOF'
# GitHub OIDC Provider for AWS Authentication
# This allows GitHub Actions to assume AWS roles without static credentials

# GitHub's OIDC provider thumbprint
# This rarely changes, but can be verified at:
# https://github.blog/changelog/2023-06-27-github-actions-update-on-oidc-integration-with-aws/

data "tls_certificate" "github" {
  url = "https://token.actions.githubusercontent.com/.well-known/openid-configuration"
}

resource "aws_iam_openid_connect_provider" "github" {
  url = "https://token.actions.githubusercontent.com"

  client_id_list = ["sts.amazonaws.com"]

  thumbprint_list = [data.tls_certificate.github.certificates[0].sha1_fingerprint]

  tags = {
    Name = "github-actions-oidc"
  }
}

# IAM Role for GitHub Actions - Terraform
resource "aws_iam_role" "github_actions_terraform" {
  name = "${var.project_name}-github-terraform"

  assume_role_policy = jsonencode({
    Version = "2012-10-17"
    Statement = [
      {
        Effect = "Allow"
        Principal = {
          Federated = aws_iam_openid_connect_provider.github.arn
        }
        Action = "sts:AssumeRoleWithWebIdentity"
        Condition = {
          StringEquals = {
            "token.actions.githubusercontent.com:aud" = "sts.amazonaws.com"
          }
          StringLike = {
            # Restrict to specific repos
            "token.actions.githubusercontent.com:sub" = [
              "repo:TechITFactory/techitfactory-infra:*",
              "repo:TechITFactory/techitfactory-app:*",
              "repo:TechITFactory/techitfactory-gitops:*"
            ]
          }
        }
      }
    ]
  })

  tags = {
    Name = "${var.project_name}-github-terraform"
  }
}

# Policy for Terraform operations
resource "aws_iam_role_policy" "github_actions_terraform" {
  name = "terraform-permissions"
  role = aws_iam_role.github_actions_terraform.id

  policy = jsonencode({
    Version = "2012-10-17"
    Statement = [
      {
        Sid    = "TerraformStateAccess"
        Effect = "Allow"
        Action = [
          "s3:GetObject",
          "s3:PutObject",
          "s3:DeleteObject",
          "s3:ListBucket"
        ]
        Resource = [
          aws_s3_bucket.terraform_state.arn,
          "${aws_s3_bucket.terraform_state.arn}/*"
        ]
      },
      {
        Sid    = "TerraformLockAccess"
        Effect = "Allow"
        Action = [
          "dynamodb:GetItem",
          "dynamodb:PutItem",
          "dynamodb:DeleteItem"
        ]
        Resource = aws_dynamodb_table.terraform_lock.arn
      },
      {
        Sid    = "KMSAccess"
        Effect = "Allow"
        Action = [
          "kms:Decrypt",
          "kms:Encrypt",
          "kms:GenerateDataKey"
        ]
        Resource = aws_kms_key.terraform_state.arn
      },
      {
        Sid    = "EC2VPCFullAccess"
        Effect = "Allow"
        Action = [
          "ec2:*",
          "elasticloadbalancing:*"
        ]
        Resource = "*"
      },
      {
        Sid    = "EKSFullAccess"
        Effect = "Allow"
        Action = [
          "eks:*",
          "iam:CreateServiceLinkedRole"
        ]
        Resource = "*"
      },
      {
        Sid    = "IAMPassRole"
        Effect = "Allow"
        Action = [
          "iam:CreateRole",
          "iam:DeleteRole",
          "iam:AttachRolePolicy",
          "iam:DetachRolePolicy",
          "iam:PutRolePolicy",
          "iam:DeleteRolePolicy",
          "iam:GetRole",
          "iam:GetRolePolicy",
          "iam:ListRolePolicies",
          "iam:ListAttachedRolePolicies",
          "iam:PassRole",
          "iam:CreateOpenIDConnectProvider",
          "iam:DeleteOpenIDConnectProvider",
          "iam:GetOpenIDConnectProvider",
          "iam:TagRole",
          "iam:UntagRole",
          "iam:ListInstanceProfilesForRole"
        ]
        Resource = "*"
      },
      {
        Sid    = "Route53Access"
        Effect = "Allow"
        Action = [
          "route53:*",
          "acm:*"
        ]
        Resource = "*"
      }
    ]
  })
}

# Output the role ARN for GitHub Actions
output "github_actions_role_arn" {
  description = "ARN of IAM role for GitHub Actions"
  value       = aws_iam_role.github_actions_terraform.arn
}
EOF
```

### Step 1.2: Update Terraform Providers (add TLS)
```bash
# Add tls provider to main.tf for certificate lookup
cat >> bootstrap/main.tf << 'EOF'

# TLS provider for GitHub OIDC certificate
terraform {
  required_providers {
    tls = {
      source  = "hashicorp/tls"
      version = "~> 4.0"
    }
  }
}
EOF
```

### Step 1.3: Apply OIDC Configuration
```bash
cd bootstrap
terraform init -upgrade  # Get TLS provider
terraform plan
terraform apply
# Type 'yes'

# Save the role ARN
terraform output github_actions_role_arn
```

---

## Part 2: Create GitHub Actions Workflow

### Step 2.1: Create Terraform CI Workflow
```bash
cd ~/techitfactory/techitfactory-infra

cat > .github/workflows/terraform-ci.yml << 'EOF'
name: Terraform CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  AWS_REGION: ap-south-1
  TF_VERSION: 1.6.0

permissions:
  id-token: write   # Required for OIDC
  contents: read
  pull-requests: write

jobs:
  terraform:
    name: Terraform Plan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Format Check
        id: fmt
        run: terraform fmt -check -recursive
        continue-on-error: true

      - name: Terraform Init
        id: init
        run: |
          cd bootstrap
          terraform init

      - name: Terraform Validate
        id: validate
        run: |
          cd bootstrap
          terraform validate

      - name: Terraform Plan
        id: plan
        if: github.event_name == 'pull_request'
        run: |
          cd bootstrap
          terraform plan -no-color -out=tfplan
        continue-on-error: true

      - name: Comment PR with Plan
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        with:
          script: |
            const output = `#### Terraform Format ðŸ–Œ \`${{ steps.fmt.outcome }}\`
            #### Terraform Init âš™ï¸ \`${{ steps.init.outcome }}\`
            #### Terraform Validate ðŸ¤– \`${{ steps.validate.outcome }}\`
            #### Terraform Plan ðŸ“– \`${{ steps.plan.outcome }}\`

            *Pushed by: @${{ github.actor }}, Action: \`${{ github.event_name }}\`*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            })
EOF
```

### Step 2.2: Add Role ARN as GitHub Secret
```bash
# Get the role ARN
cd bootstrap
ROLE_ARN=$(terraform output -raw github_actions_role_arn)
echo "Role ARN: $ROLE_ARN"

# Add to GitHub Secrets via CLI
gh secret set AWS_ROLE_ARN --body "$ROLE_ARN" --repo TechITFactory/techitfactory-infra

# Or manually:
# 1. Go to repo Settings â†’ Secrets â†’ Actions
# 2. Add new secret: AWS_ROLE_ARN
# 3. Value: <paste the role ARN>
```

---

## Part 3: Commit and Test

### Step 3.1: Commit Changes
```bash
cd ~/techitfactory/techitfactory-infra
git checkout -b feature/github-oidc

git add bootstrap/github-oidc.tf
git add .github/workflows/terraform-ci.yml

git commit -m "Add GitHub OIDC authentication for AWS"
git push origin feature/github-oidc
```

### Step 3.2: Create PR and Watch Workflow
```bash
gh pr create --title "Epic 2: Add GitHub OIDC for AWS" \
  --body "Adds OIDC provider and IAM role for GitHub Actions to authenticate with AWS without static credentials."

# Watch the workflow run
gh run watch
```

### Step 3.3: Verify OIDC Works
```
1. Go to GitHub â†’ Actions tab
2. Check the workflow run
3. "Configure AWS Credentials" step should show:
   - "Assuming role with OIDC"
   - "Successfully assumed role"
```

---

## Verification

### Check OIDC Provider in AWS
```bash
aws iam list-open-id-connect-providers
# Should show: arn:aws:iam::<account>:oidc-provider/token.actions.githubusercontent.com
```

### Check IAM Role
```bash
aws iam get-role --role-name techitfactory-github-terraform
# Should show the trust policy with GitHub OIDC
```

### Test from GitHub Actions
```bash
# Create a test workflow run
git commit --allow-empty -m "Test OIDC authentication"
git push
# Check Actions tab for successful AWS authentication
```

---

## Story Completion Checklist
- [ ] OIDC provider created in AWS
- [ ] IAM role created with trust policy
- [ ] IAM role has necessary permissions
- [ ] GitHub workflow created
- [ ] AWS_ROLE_ARN secret added to GitHub
- [ ] Workflow runs successfully with OIDC
- [ ] No static AWS keys in secrets
