# Sprint 3, Story 6.1: Create ECR Repositories

## Story Summary
Create Amazon ECR repositories for microservices container images.

**What We're Creating:**
- ECR repositories for each microservice
- Lifecycle policies for image cleanup
- Repository policies for cross-account access (optional)

---

## Prerequisites
- AWS credentials configured
- Terraform initialized

---

## Part 1: Create ECR Module

### Step 1.1: Create Module Structure
```bash
mkdir -p ~/Desktop/Devops-Project/techitfactory-infra/modules/ecr
cd ~/Desktop/Devops-Project/techitfactory-infra/modules/ecr
```

### Step 1.2: Create variables.tf
```hcl
variable "project_name" {
  description = "Project name for resource naming"
  type        = string
}

variable "environment" {
  description = "Environment (dev/prod)"
  type        = string
}

variable "repositories" {
  description = "List of ECR repository names"
  type        = list(string)
  default     = []
}

variable "image_tag_mutability" {
  description = "Tag mutability setting"
  type        = string
  default     = "MUTABLE"
}

variable "scan_on_push" {
  description = "Enable image scanning on push"
  type        = bool
  default     = true
}

variable "lifecycle_policy_count" {
  description = "Number of tagged images to keep"
  type        = number
  default     = 30
}

variable "tags" {
  description = "Additional tags"
  type        = map(string)
  default     = {}
}
```

### Step 1.3: Create main.tf
```hcl
locals {
  common_tags = merge(
    {
      Module      = "ecr"
      Environment = var.environment
    },
    var.tags
  )
}

# ECR Repositories
resource "aws_ecr_repository" "repos" {
  for_each = toset(var.repositories)

  name                 = "${var.project_name}/${each.key}"
  image_tag_mutability = var.image_tag_mutability

  image_scanning_configuration {
    scan_on_push = var.scan_on_push
  }

  encryption_configuration {
    encryption_type = "AES256"
  }

  tags = merge(local.common_tags, {
    Name = "${var.project_name}/${each.key}"
  })
}

# Lifecycle Policy - cleanup old images
resource "aws_ecr_lifecycle_policy" "repos" {
  for_each   = toset(var.repositories)
  repository = aws_ecr_repository.repos[each.key].name

  policy = jsonencode({
    rules = [
      {
        rulePriority = 1
        description  = "Keep last ${var.lifecycle_policy_count} tagged images"
        selection = {
          tagStatus     = "tagged"
          tagPrefixList = ["v", "release"]
          countType     = "imageCountMoreThan"
          countNumber   = var.lifecycle_policy_count
        }
        action = {
          type = "expire"
        }
      },
      {
        rulePriority = 2
        description  = "Delete untagged images older than 7 days"
        selection = {
          tagStatus   = "untagged"
          countType   = "sinceImagePushed"
          countUnit   = "days"
          countNumber = 7
        }
        action = {
          type = "expire"
        }
      }
    ]
  })
}
```

### Step 1.4: Create outputs.tf
```hcl
output "repository_urls" {
  description = "Map of repository names to URLs"
  value       = { for k, v in aws_ecr_repository.repos : k => v.repository_url }
}

output "repository_arns" {
  description = "Map of repository names to ARNs"
  value       = { for k, v in aws_ecr_repository.repos : k => v.arn }
}

output "registry_id" {
  description = "ECR registry ID (AWS account ID)"
  value       = values(aws_ecr_repository.repos)[0].registry_id
}
```

---

## Part 2: Add ECR to Dev Environment

### Step 2.1: Update environments/dev/main.tf
```hcl
# Add ECR module
module "ecr" {
  source = "../../modules/ecr"

  project_name = local.project_name
  environment  = local.environment

  repositories = [
    "frontend",
    "api-gateway",
    "user-service",
    "order-service",
    "product-service"
  ]

  lifecycle_policy_count = 30
  scan_on_push           = true
}

# Add outputs
output "ecr_repository_urls" {
  description = "ECR repository URLs"
  value       = module.ecr.repository_urls
}
```

### Step 2.2: Apply
```bash
cd ~/Desktop/Devops-Project/techitfactory-infra/environments/dev
terraform init -upgrade
terraform plan
terraform apply
```

---

## Verification

### List Repositories
```bash
aws ecr describe-repositories --query "repositories[*].{Name:repositoryName,URI:repositoryUri}"
```

### Test Docker Login
```bash
aws ecr get-login-password --region ap-south-1 | \
  docker login --username AWS --password-stdin \
  $(aws sts get-caller-identity --query Account --output text).dkr.ecr.ap-south-1.amazonaws.com
```

---

## Commit and Push

```bash
cd ~/Desktop/Devops-Project/techitfactory-infra
git add modules/ecr/
git add environments/dev/
git commit -m "Add ECR module with repositories for microservices"
git push origin main
```

---

## Story Completion Checklist
- [ ] ECR module created
- [ ] Repositories for all microservices
- [ ] Lifecycle policies configured
- [ ] Module added to dev environment
- [ ] terraform apply successful
- [ ] Docker login works

---

## Next: Story 6.2 (Build and Push Docker Images)
