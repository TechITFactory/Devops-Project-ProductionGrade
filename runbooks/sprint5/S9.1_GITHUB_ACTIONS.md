# Sprint 5, Story 9.1: GitHub Actions CI/CD

## Story Summary
Create GitHub Actions workflows for automated CI/CD across all repositories.

**What We're Building:**
- **techitfactory-infra**: 1 workflow (Terraform)
- **techitfactory-app**: 2 workflows (CI + Release)
- **techitfactory-gitops**: 1 workflow (Validation)

---

## Part 1: Workflow Architecture

### Real-World Structure
```
techitfactory-infra/
└── .github/workflows/
    └── terraform-ci.yml        # Terraform plan/apply

techitfactory-app/
└── .github/workflows/
    ├── ci.yml                  # Unified CI (all services)
    ├── release.yml             # Production releases
    └── sonarcloud.yml          # Code quality (optional)

techitfactory-gitops/
└── .github/workflows/
    └── validate.yml            # YAML/Kustomize validation
```

**Total: 4-5 workflows** (not 9!)

---

## Part 2: Unified CI Workflow (techitfactory-app)

### Key Features
1. **Change Detection**: Only builds services that changed
2. **Matrix Builds**: Parallel builds for changed services
3. **Single File**: One workflow for all 6 services

### How It Works
```
Push to services/api-gateway/*
         ↓
detect-changes job identifies "api-gateway" changed
         ↓
test job runs ONLY for api-gateway
         ↓
build job pushes ONLY api-gateway image
         ↓
update-gitops updates ONLY api-gateway tag
```

### Workflow File: ci.yml
```yaml
name: CI

on:
  push:
    branches: [main]
    paths:
      - 'services/**'
  pull_request:
    branches: [main]

jobs:
  detect-changes:
    # Uses paths-filter to detect which services changed
    
  test:
    # Matrix job - tests only changed services
    
  build:
    # Matrix job - builds only changed services
    
  update-gitops:
    # Updates GitOps repo for each built service
```

---

## Part 3: Terraform CI (techitfactory-infra)

### Already Created: terraform-ci.yml
- Triggers on: `modules/**`, `environments/**`
- Jobs: format → validate → plan → (apply on main)
- Uses OIDC for AWS authentication

---

## Part 4: GitOps Validation (techitfactory-gitops)

### validate.yml
```yaml
name: Validate Manifests

on:
  push:
    branches: [main]
  pull_request:

jobs:
  validate:
    steps:
      - Validate YAML syntax
      - Build kustomize overlays
```

---

## Part 5: Required Secrets

### techitfactory-infra
| Secret | Description |
|--------|-------------|
| (None) | Uses OIDC - no secrets needed! |

### techitfactory-app
| Secret | Description |
|--------|-------------|
| `AWS_ROLE_ARN` | IAM role for ECR push |
| `GITOPS_TOKEN` | PAT for updating GitOps repo |
| `SONAR_TOKEN` | (Optional) SonarCloud |

### techitfactory-gitops
| Secret | Description |
|--------|-------------|
| (None) | Just validation, no secrets needed |

---

## Part 6: Setting Up GITOPS_TOKEN

1. Go to GitHub → Settings → Developer settings
2. Personal access tokens → Generate new token (classic)
3. Select scopes: `repo` (full)
4. Copy token
5. Add as secret in `techitfactory-app` repo

---

## Part 7: Testing the Pipeline

### Test CI Trigger
```bash
cd techitfactory-app

# Modify just one service
echo "# test" >> services/api-gateway/README.md

# Commit and push
git add . && git commit -m "test: trigger CI" && git push

# Watch Actions - ONLY api-gateway should build
```

### Expected Behavior
| Change | What Builds |
|--------|-------------|
| `services/api-gateway/*` | Only api-gateway |
| `services/product/*` | Only product-service |
| `services/order/*` + `services/cart/*` | Both order + cart |
| None in services/ | Nothing builds |

---

## Verification

- [ ] Changes to one service only build that service
- [ ] Tests run before build
- [ ] Images pushed to ECR
- [ ] GitOps repo updated with new tag
- [ ] ArgoCD syncs automatically

---

## Summary: Final Workflow Count

| Repository | Workflows | Purpose |
|------------|-----------|---------|
| techitfactory-infra | 1 | Terraform CI/CD |
| techitfactory-app | 2-3 | CI + Release + (SonarCloud) |
| techitfactory-gitops | 1 | Validation |
| **Total** | **4-5** | Production ready! |

---

## Next: Story 9.2 (SonarCloud - Optional)
