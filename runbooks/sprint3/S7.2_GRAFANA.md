# Sprint 4, Story 8.2: Configure Grafana Dashboards

## Story Summary
Set up Grafana dashboards for visualization and monitoring.

**What We're Configuring:**
- Grafana access
- Pre-built Kubernetes dashboards
- Custom application dashboards
- Dashboard-as-code

---

## Prerequisites
- S8.1 completed (Prometheus stack installed)
- Grafana running in monitoring namespace

---

## Part 1: Access Grafana

### Step 1.1: Get Admin Password
```bash
# If you used the default values
kubectl get secret -n monitoring prometheus-grafana -o jsonpath="{.data.admin-password}" | base64 -d
echo
```

### Step 1.2: Port Forward
```bash
kubectl port-forward svc/prometheus-grafana -n monitoring 3000:80
# Open http://localhost:3000
# Login: admin / <password from above>
```

### Step 1.3: ALB Ingress (Optional)
```bash
kubectl apply -f - <<EOF
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: grafana
  namespace: monitoring
  annotations:
    alb.ingress.kubernetes.io/scheme: internet-facing
    alb.ingress.kubernetes.io/target-type: ip
    alb.ingress.kubernetes.io/certificate-arn: <ACM_CERT_ARN>
    alb.ingress.kubernetes.io/listen-ports: '[{"HTTPS":443}]'
    alb.ingress.kubernetes.io/ssl-redirect: '443'
spec:
  ingressClassName: alb
  rules:
  - host: grafana.techitfactory.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: prometheus-grafana
            port:
              number: 80
EOF
```

---

## Part 2: Import Community Dashboards

### Popular Dashboard IDs

| Dashboard | ID | Description |
|-----------|-----|-------------|
| Kubernetes Cluster | 6417 | Overall cluster health |
| Node Exporter Full | 1860 | Node-level metrics |
| Kubernetes Pods | 6336 | Pod-level metrics |
| CoreDNS | 5926 | DNS metrics |
| NGINX Ingress | 9614 | Ingress metrics |

### Import Dashboard
1. Go to Dashboards → Import
2. Enter Dashboard ID (e.g., 6417)
3. Click "Load"
4. Select Prometheus data source
5. Click "Import"

---

## Part 3: Create Custom Dashboard

### Step 3.1: Create Dashboard ConfigMap
```bash
kubectl apply -f - <<EOF
apiVersion: v1
kind: ConfigMap
metadata:
  name: techitfactory-dashboard
  namespace: monitoring
  labels:
    grafana_dashboard: "1"  # Auto-discovered by Grafana
data:
  techitfactory.json: |
    {
      "annotations": {
        "list": []
      },
      "editable": true,
      "fiscalYearStartMonth": 0,
      "graphTooltip": 0,
      "id": null,
      "links": [],
      "liveNow": false,
      "panels": [
        {
          "datasource": {
            "type": "prometheus",
            "uid": "prometheus"
          },
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "palette-classic"
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {"color": "green", "value": null},
                  {"color": "yellow", "value": 50},
                  {"color": "red", "value": 80}
                ]
              },
              "unit": "percent"
            }
          },
          "gridPos": {"h": 8, "w": 12, "x": 0, "y": 0},
          "id": 1,
          "options": {
            "reduceOptions": {
              "calcs": ["lastNotNull"],
              "fields": "",
              "values": false
            }
          },
          "pluginVersion": "9.0.0",
          "targets": [
            {
              "expr": "100 - (avg(rate(node_cpu_seconds_total{mode=\"idle\"}[5m])) * 100)",
              "refId": "A"
            }
          ],
          "title": "Cluster CPU Usage",
          "type": "gauge"
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "prometheus"
          },
          "fieldConfig": {
            "defaults": {
              "color": {"mode": "palette-classic"},
              "unit": "bytes"
            }
          },
          "gridPos": {"h": 8, "w": 12, "x": 12, "y": 0},
          "id": 2,
          "targets": [
            {
              "expr": "sum(container_memory_usage_bytes{namespace=\"techitfactory\"}) by (pod)",
              "legendFormat": "{{pod}}",
              "refId": "A"
            }
          ],
          "title": "Pod Memory Usage",
          "type": "timeseries"
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "prometheus"
          },
          "gridPos": {"h": 8, "w": 24, "x": 0, "y": 8},
          "id": 3,
          "targets": [
            {
              "expr": "sum(rate(http_requests_total{namespace=\"techitfactory\"}[5m])) by (service)",
              "legendFormat": "{{service}}",
              "refId": "A"
            }
          ],
          "title": "HTTP Request Rate",
          "type": "timeseries"
        }
      ],
      "refresh": "5s",
      "schemaVersion": 36,
      "style": "dark",
      "tags": ["techitfactory"],
      "templating": {"list": []},
      "time": {"from": "now-1h", "to": "now"},
      "title": "TechITFactory Overview",
      "uid": "techitfactory-overview"
    }
EOF
```

---

## Part 4: Alerting in Grafana

### Step 4.1: Configure Alert Contact Point
1. Go to Alerting → Contact points
2. Click "New contact point"
3. Select type (Slack, Email, PagerDuty, etc.)
4. Configure settings
5. Test and save

### Step 4.2: Create Alert Rule
1. Go to Alerting → Alert rules
2. Click "New alert rule"
3. Configure:
   - Query: `sum(rate(http_requests_total{status=~"5.."}[5m])) > 10`
   - Condition: Above threshold
   - Duration: 5m
4. Set contact point
5. Save

---

## Part 5: Dashboard Best Practices

### Use Variables
```json
{
  "templating": {
    "list": [
      {
        "name": "namespace",
        "type": "query",
        "query": "label_values(kube_pod_info, namespace)",
        "refresh": 1
      }
    ]
  }
}
```

### Useful Queries for TechITFactory

| Metric | Query |
|--------|-------|
| Request Rate | `sum(rate(http_requests_total[5m])) by (service)` |
| Error Rate | `sum(rate(http_requests_total{status=~"5.."}[5m])) / sum(rate(http_requests_total[5m])) * 100` |
| P99 Latency | `histogram_quantile(0.99, rate(http_request_duration_seconds_bucket[5m]))` |
| Pod Restarts | `sum(kube_pod_container_status_restarts_total{namespace="techitfactory"}) by (pod)` |
| Memory Usage % | `container_memory_usage_bytes / container_spec_memory_limit_bytes * 100` |

---

## Part 6: GitOps for Dashboards

### Store Dashboards in Git
```bash
# Add to techitfactory-gitops
mkdir -p monitoring/dashboards

# Export dashboard from Grafana UI (Share → Export → Save to file)
# Save as monitoring/dashboards/techitfactory-overview.json
```

### ArgoCD Application for Monitoring
```yaml
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: monitoring-dashboards
  namespace: argocd
spec:
  project: default
  source:
    repoURL: https://github.com/TechITFactory/techitfactory-gitops.git
    path: monitoring/dashboards
  destination:
    server: https://kubernetes.default.svc
    namespace: monitoring
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
```

---

## Verification

### Check Dashboards Loaded
```bash
kubectl get configmaps -n monitoring -l grafana_dashboard=1
```

### Test Alert
```bash
# Trigger high error rate (in test)
for i in {1..100}; do curl -s http://api-gateway/nonexistent; done
```

---

## Story Completion Checklist
- [ ] Grafana accessible
- [ ] Prometheus data source connected
- [ ] Community dashboards imported
- [ ] Custom dashboard created
- [ ] Alerts configured
- [ ] Dashboards stored in Git

---

## Next: Story 8.3 (Loki for Logs)
