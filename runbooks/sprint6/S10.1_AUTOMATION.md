# Sprint 6, Story 10.1: Daily Build & Destroy Automation

## Story Summary
Create one-command scripts to spin up and tear down the entire environment.

**What We're Building:**
- `make up` - Deploy everything (~15-20 min)
- `make down` - Destroy everything (~10 min)
- Idempotent operations

---

## Prerequisites
- All tools installed (AWS CLI, Terraform, kubectl, Helm)
- Repositories cloned locally

---

## Part 1: Makefile

### Create Makefile in Root

```makefile
# Makefile - TechITFactory Platform Orchestration

.PHONY: up down infra k8s apps clean status help

# Variables
INFRA_DIR := techitfactory-infra/environments/dev
BOOTSTRAP_DIR := techitfactory-infra/bootstrap
GITOPS_DIR := techitfactory-gitops
REGION := ap-south-1
CLUSTER_NAME := techitfactory-dev

help:
	@echo "TechITFactory Platform Commands"
	@echo "================================"
	@echo "make up        - Deploy entire platform (~20 min)"
	@echo "make down      - Destroy entire platform (~10 min)"
	@echo "make infra     - Deploy infrastructure only"
	@echo "make k8s       - Configure Kubernetes add-ons"
	@echo "make apps      - Deploy applications"
	@echo "make status    - Check platform status"
	@echo "make clean     - Clean local artifacts"

# ============================================
# FULL PLATFORM
# ============================================

up: infra k8s apps
	@echo ""
	@echo "âœ… Platform deployment complete!"
	@echo "Run 'make status' to check all components"

down: down-apps down-k8s down-infra
	@echo ""
	@echo "âœ… Platform destroyed!"

# ============================================
# INFRASTRUCTURE
# ============================================

infra:
	@echo "ðŸš€ Deploying infrastructure..."
	cd $(INFRA_DIR) && terraform init -upgrade
	cd $(INFRA_DIR) && terraform apply -auto-approve
	@echo "â³ Waiting for EKS to be ready..."
	aws eks wait cluster-active --name $(CLUSTER_NAME) --region $(REGION) || true
	aws eks update-kubeconfig --name $(CLUSTER_NAME) --region $(REGION)
	@echo "âœ… Infrastructure deployed!"

down-infra:
	@echo "ðŸ—‘ï¸ Destroying infrastructure..."
	cd $(INFRA_DIR) && terraform destroy -auto-approve
	@echo "âœ… Infrastructure destroyed!"

# ============================================
# KUBERNETES ADD-ONS
# ============================================

k8s: k8s-alb k8s-argocd k8s-monitoring
	@echo "âœ… Kubernetes add-ons installed!"

k8s-alb:
	@echo "ðŸ“¦ Installing AWS Load Balancer Controller..."
	helm repo add eks https://aws.github.io/eks-charts || true
	helm repo update
	helm upgrade --install aws-load-balancer-controller eks/aws-load-balancer-controller \
		-n kube-system \
		--set clusterName=$(CLUSTER_NAME) \
		--set serviceAccount.create=true \
		--set region=$(REGION)
	kubectl wait --for=condition=available deployment/aws-load-balancer-controller -n kube-system --timeout=300s

k8s-argocd:
	@echo "ðŸ“¦ Installing ArgoCD..."
	kubectl create namespace argocd --dry-run=client -o yaml | kubectl apply -f -
	kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml
	kubectl wait --for=condition=Ready pods --all -n argocd --timeout=300s
	@echo "ArgoCD Password:"
	@kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d
	@echo ""

k8s-monitoring:
	@echo "ðŸ“¦ Installing Prometheus & Loki..."
	helm repo add prometheus-community https://prometheus-community.github.io/helm-charts || true
	helm repo add grafana https://grafana.github.io/helm-charts || true
	helm repo update
	kubectl create namespace monitoring --dry-run=client -o yaml | kubectl apply -f -
	helm upgrade --install prometheus prometheus-community/kube-prometheus-stack \
		-n monitoring \
		-f $(GITOPS_DIR)/monitoring/prometheus-values.yaml \
		--wait --timeout=10m
	helm upgrade --install loki grafana/loki-stack \
		-n monitoring \
		-f $(GITOPS_DIR)/monitoring/loki-values.yaml

down-k8s:
	@echo "ðŸ—‘ï¸ Removing Kubernetes add-ons..."
	helm uninstall loki -n monitoring || true
	helm uninstall prometheus -n monitoring || true
	kubectl delete namespace monitoring --ignore-not-found
	kubectl delete -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml || true
	kubectl delete namespace argocd --ignore-not-found
	helm uninstall aws-load-balancer-controller -n kube-system || true

# ============================================
# APPLICATIONS
# ============================================

apps: apps-namespace apps-argocd
	@echo "âœ… Applications deployed!"

apps-namespace:
	kubectl create namespace techitfactory --dry-run=client -o yaml | kubectl apply -f -
	kubectl create namespace techitfactory-prod --dry-run=client -o yaml | kubectl apply -f -

apps-argocd:
	@echo "ðŸ“¦ Deploying applications via ArgoCD..."
	kubectl apply -f $(GITOPS_DIR)/apps/root-app.yaml
	@echo "Waiting for ArgoCD to sync..."
	sleep 30
	argocd app sync root-app --insecure || true

down-apps:
	@echo "ðŸ—‘ï¸ Removing applications..."
	kubectl delete namespace techitfactory --ignore-not-found
	kubectl delete namespace techitfactory-prod --ignore-not-found

# ============================================
# STATUS & UTILITIES
# ============================================

status:
	@echo "ðŸ“Š Platform Status"
	@echo "=================="
	@echo ""
	@echo "ðŸ”¹ Nodes:"
	@kubectl get nodes 2>/dev/null || echo "  Not connected to cluster"
	@echo ""
	@echo "ðŸ”¹ Core Namespaces:"
	@kubectl get ns 2>/dev/null | grep -E "techitfactory|monitoring|argocd" || echo "  None found"
	@echo ""
	@echo "ðŸ”¹ Pods (techitfactory):"
	@kubectl get pods -n techitfactory 2>/dev/null || echo "  None found"
	@echo ""
	@echo "ðŸ”¹ ArgoCD Apps:"
	@argocd app list 2>/dev/null || echo "  ArgoCD not accessible"

clean:
	rm -rf .terraform
	rm -f terraform.tfstate*
	rm -f kubeconfig
```

---

## Part 2: Shell Scripts

### 2.1: up.sh

```bash
#!/bin/bash
# up.sh - Deploy TechITFactory Platform

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
START_TIME=$(date +%s)

echo "ðŸš€ TechITFactory Platform Deployment"
echo "======================================"
echo ""

# Step 1: Infrastructure
echo "[1/4] Deploying Infrastructure..."
cd $SCRIPT_DIR/techitfactory-infra/environments/dev
terraform init -upgrade
terraform apply -auto-approve

# Get cluster config
CLUSTER_NAME="techitfactory-dev"
REGION="ap-south-1"
aws eks update-kubeconfig --name $CLUSTER_NAME --region $REGION

# Step 2: Wait for nodes
echo "[2/4] Waiting for nodes..."
kubectl wait --for=condition=Ready nodes --all --timeout=300s

# Step 3: Install add-ons
echo "[3/4] Installing Kubernetes add-ons..."

# ALB Controller
helm repo add eks https://aws.github.io/eks-charts
helm repo update
helm upgrade --install aws-load-balancer-controller eks/aws-load-balancer-controller \
  -n kube-system \
  --set clusterName=$CLUSTER_NAME \
  --set serviceAccount.create=true \
  --set region=$REGION

# ArgoCD
kubectl create namespace argocd --dry-run=client -o yaml | kubectl apply -f -
kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml
kubectl wait --for=condition=Ready pods --all -n argocd --timeout=300s

# Monitoring
kubectl create namespace monitoring --dry-run=client -o yaml | kubectl apply -f -
helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
helm repo add grafana https://grafana.github.io/helm-charts
helm repo update

helm upgrade --install prometheus prometheus-community/kube-prometheus-stack -n monitoring --wait --timeout=10m
helm upgrade --install loki grafana/loki-stack -n monitoring

# Step 4: Deploy apps
echo "[4/4] Deploying applications..."
kubectl create namespace techitfactory --dry-run=client -o yaml | kubectl apply -f -
kubectl apply -f $SCRIPT_DIR/techitfactory-gitops/apps/root-app.yaml

# Done
END_TIME=$(date +%s)
DURATION=$((END_TIME - START_TIME))

echo ""
echo "âœ… Platform deployed in $((DURATION / 60)) minutes $((DURATION % 60)) seconds!"
echo ""
echo "ArgoCD Password: $(kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath='{.data.password}' | base64 -d)"
echo ""
echo "Access:"
echo "  kubectl port-forward svc/argocd-server -n argocd 8080:443"
echo "  kubectl port-forward svc/prometheus-grafana -n monitoring 3000:80"
```

### 2.2: down.sh

```bash
#!/bin/bash
# down.sh - Destroy TechITFactory Platform

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

echo "ðŸ—‘ï¸ TechITFactory Platform Destruction"
echo "======================================="
echo ""
echo "âš ï¸  This will destroy ALL resources!"
read -p "Are you sure? (yes/no): " confirm

if [ "$confirm" != "yes" ]; then
  echo "Aborted."
  exit 0
fi

# Step 1: Delete Kubernetes resources
echo "[1/3] Removing Kubernetes resources..."
kubectl delete namespace techitfactory --ignore-not-found
kubectl delete namespace techitfactory-prod --ignore-not-found
helm uninstall loki -n monitoring 2>/dev/null || true
helm uninstall prometheus -n monitoring 2>/dev/null || true
kubectl delete namespace monitoring --ignore-not-found
kubectl delete -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml 2>/dev/null || true
kubectl delete namespace argocd --ignore-not-found
helm uninstall aws-load-balancer-controller -n kube-system 2>/dev/null || true

# Step 2: Wait for load balancers to be deleted
echo "[2/3] Waiting for load balancers to be deleted..."
sleep 30

# Step 3: Destroy Terraform
echo "[3/3] Destroying infrastructure..."
cd $SCRIPT_DIR/techitfactory-infra/environments/dev
terraform destroy -auto-approve

echo ""
echo "âœ… Platform destroyed!"
```

---

## Part 3: Usage

### Deploy Platform
```bash
# Option 1: Using Make
make up

# Option 2: Using script
./up.sh
```

### Check Status
```bash
make status
```

### Destroy Platform
```bash
# Option 1: Using Make
make down

# Option 2: Using script
./down.sh
```

---

## Part 4: Boot Time Optimization

### Target: < 20 minutes

| Phase | Target Time |
|-------|-------------|
| Terraform (VPC+EKS+ECR) | 12-15 min |
| Node ready | 2-3 min |
| ALB Controller | 1 min |
| ArgoCD | 2 min |
| Monitoring | 3 min |
| **Total** | **~20 min** |

### Optimization Tips
1. Use `terraform apply -parallelism=20`
2. Pre-pull images to ECR
3. Use EKS managed add-ons
4. Skip optional components for dev

---

## Verification

### Check Boot Time
```bash
time make up
```

### Idempotency Test
```bash
# Run twice - should succeed both times
make up
make up  # Should not error

make down
make down  # Should not error
```

---

## Story Completion Checklist
- [ ] Makefile created
- [ ] up.sh script works
- [ ] down.sh script works
- [ ] Boot time < 20 minutes
- [ ] Idempotent operations
- [ ] Status command works

---

## Epic 10 Complete! ðŸŽ‰

**Full Course Summary:**
- âœ… Epic 1-3: Repos, Bootstrap, Networking
- âœ… Epic 4-5: EKS, Ingress
- âœ… Epic 6-7: GitOps, Observability
- âœ… Epic 8: Walking Skeleton App
- âœ… Epic 9: CI/CD Pipeline
- âœ… Epic 10: Automation
