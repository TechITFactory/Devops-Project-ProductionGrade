# Sprint 1, Story 1.2: Enforce Trunk-Based Development

## Story Summary
Configure GitHub branch protections and PR requirements for all 3 repos.

---

## Prerequisites
- 3 repos created (from Story 1.1)
- GitHub org admin access

---

## Part 1: Configure techitfactory-infra

### Step 1.1: Enable Branch Protection (GitHub UI)
```
1. Go to: https://github.com/TechITFactory/techitfactory-infra/settings/branches
2. Click "Add branch protection rule"
3. Branch name pattern: main
4. Enable:
   ✅ Require a pull request before merging
   ✅ Require approvals (1)
   ✅ Dismiss stale pull request approvals
   ✅ Require status checks to pass
   ✅ Require branches to be up to date
   ✅ Do not allow bypassing
5. Click "Create"
```

### Step 1.2: Create PR Template (if not done)
```bash
cd techitfactory-infra

cat > .github/pull_request_template.md << 'EOF'
## Description
<!-- What infrastructure changes does this PR introduce? -->

## Terraform Plan,
<!-- Paste `terraform plan` output -->

## Checklist
- [ ] terraform fmt passed
- [ ] terraform validate passed
- [ ] No secrets in code
- [ ] Cost impact reviewed
EOF

git add .
git commit -m "Add PR template"
git push origin main
```

---

## Part 2: Configure techitfactory-app

### Step 2.1: Enable Branch Protection
```
1. Go to: https://github.com/TechITFactory/techitfactory-app/settings/branches
2. Click "Add branch protection rule"
3. Branch name pattern: main
4. Enable:
   ✅ Require a pull request before merging
   ✅ Require approvals (1)
   ✅ Require status checks to pass
   ✅ Require branches to be up to date
5. Click "Create"
```

### Step 2.2: Create PR Template
```bash
cd ../techitfactory-app

cat > .github/pull_request_template.md << 'EOF'
## Description
<!-- What does this PR do? -->

## Service Affected
- [ ] frontend
- [ ] product
- [ ] cart
- [ ] order

## Checklist
- [ ] Unit tests pass
- [ ] Linting passes
- [ ] Docker build works
- [ ] /health endpoint works
- [ ] /ready endpoint works
EOF

git add .
git commit -m "Add PR template"
git push origin main
```

---

## Part 3: Configure techitfactory-gitops

### Step 3.1: Enable Branch Protection
```
1. Go to: https://github.com/TechITFactory/techitfactory-gitops/settings/branches
2. Click "Add branch protection rule"
3. Branch name pattern: main
4. Enable:
   ✅ Require a pull request before merging
   ✅ Require approvals (1) 
   ✅ Dismiss stale approvals
   ✅ Restrict who can push (platform-team only)
5. Click "Create"
```

### Step 3.2: Create PR Template
```bash
cd ../techitfactory-gitops

cat > .github/pull_request_template.md << 'EOF'
## Description
<!-- What deployment changes does this PR introduce? -->

## Environment
- [ ] dev
- [ ] prod

## Change Type
- [ ] New app deployment
- [ ] Image version update
- [ ] Config change
- [ ] Rollback

## Checklist
- [ ] YAML is valid
- [ ] Helm values are correct
- [ ] ArgoCD can parse this
EOF

git add .
git commit -m "Add PR template"
git push origin main
```

---

## Part 4: Test the Protection

### Step 4.1: Try Direct Push (Should Fail)
```bash
cd techitfactory-infra

# Make a change
echo "# Test" >> README.md

# Try to push directly (should fail)
git add .
git commit -m "Direct push test"
git push origin main
# Expected: rejected - protected branch
```

### Step 4.2: Use PR Workflow (Should Work)
```bash
# Create feature branch
git checkout -b test/branch-protection

# Push branch
git push origin test/branch-protection

# Create PR via GitHub UI or CLI
gh pr create --title "Test: Branch Protection" --body "Testing PR requirement"

# Delete test branch after
git checkout main
git branch -D test/branch-protection
```

---

## Verification

### Check Protection Status
```bash
# Using GitHub CLI
gh api repos/TechITFactory/techitfactory-infra/branches/main/protection

# Should show:
# - required_pull_request_reviews
# - required_status_checks
```

---

## Story Completion Checklist
- [ ] techitfactory-infra: main protected
- [ ] techitfactory-app: main protected
- [ ] techitfactory-gitops: main protected
- [ ] PR templates in all repos
- [ ] Direct push blocked (tested)
- [ ] PR workflow works (tested)
