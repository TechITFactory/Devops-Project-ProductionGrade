# Sprint 1, Story 3.1+3.2: Provision VPC with Endpoints

## Story Summary
Implement the complete VPC module with multi-AZ networking for EKS, including VPC endpoints for cost optimization.

**What We're Building:**
- VPC with DNS support (10.0.0.0/16)
- 2 Public Subnets (for ALB, NAT)
- 2 Private Subnets (for EKS nodes)
- Internet Gateway
- Single NAT Gateway (cost-optimized)
- Route Tables
- S3 VPC Endpoint (FREE - always enabled)
- Interface Endpoints code (ECR, Logs, STS - disabled by default)

> **ðŸ’¡ Cost Note:** S3 Gateway endpoint is FREE. Interface endpoints cost ~$7.50/month each.
> For learning, we keep interface endpoints disabled. The code is ready - just uncomment when needed.

---

## Prerequisites
- S2.1-S2.3 completed (bootstrap + module skeleton)
- AWS credentials configured

---

## Part 0: Verify Prerequisites

### Step 0.1: Verify AWS Credentials
```bash
# Check AWS identity
aws sts get-caller-identity

# Expected output:
# {
#     "UserId": "AIDAXXXXXXXXXX",
#     "Account": "123456789012",
#     "Arn": "arn:aws:iam::123456789012:user/your-user"
# }
```

### Step 0.2: Verify Bootstrap Completed
```bash
cd ~/Desktop/Devops-Project/techitfactory-infra/bootstrap

# Get state bucket name - COPY THIS VALUE
terraform output state_bucket_name

# Get lock table name - COPY THIS VALUE
terraform output lock_table_name
```

---

## Part 1: Understanding VPC Architecture

### The Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           VPC (10.0.0.0/16)                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚   AZ-1 (ap-south-1a)                 â”‚   AZ-2 (ap-south-1b)  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  â”‚ Public      â”‚ â† Internet Gateway  â”‚  â”‚ Public      â”‚      â”‚
â”‚  â”‚  â”‚ 10.0.1.0/24 â”‚                     â”‚  â”‚ 10.0.2.0/24 â”‚      â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  â”‚ Private     â”‚ â† NAT Gateway       â”‚  â”‚ Private     â”‚      â”‚
â”‚  â”‚  â”‚ 10.0.10.0/24â”‚   (in public)       â”‚  â”‚ 10.0.20.0/24â”‚      â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                  â”‚
â”‚  VPC Endpoints: S3 (Gateway) âœ… | ECR, Logs, STS (optional)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Why this design?**
- **Public Subnets**: Internet-facing resources (ALB, NAT Gateway)
- **Private Subnets**: Workloads like EKS nodes (no direct internet access)
- **Single NAT Gateway**: Cost optimization ($32/month vs $64 for HA)
- **VPC Endpoints**: Keep traffic in AWS network, reduce NAT costs

---

## Part 2: Review VPC Module Code

> **âœ… The VPC module code is already complete in the repo!**
> Let's understand what each resource does.

### Step 2.1: Navigate to VPC Module
```bash
cd ~/Desktop/Devops-Project/techitfactory-infra/modules/vpc
ls -la
```

### Step 2.2: Understanding main.tf

Let's walk through the key resources:

#### VPC Resource
```hcl
resource "aws_vpc" "main" {
  cidr_block           = var.vpc_cidr          # 10.0.0.0/16 = 65,536 IPs
  enable_dns_hostnames = true                  # Required for EKS
  enable_dns_support   = true                  # Required for EKS

  tags = merge(local.common_tags, {
    Name = "${local.name}-vpc"
  })
}
```

**Why `enable_dns_hostnames = true`?**
- EKS needs DNS hostnames to resolve node names
- Many AWS services require this for private DNS

#### Internet Gateway
```hcl
resource "aws_internet_gateway" "main" {
  vpc_id = aws_vpc.main.id
}
```

**What it does:**
- Provides internet connectivity for public subnets
- Free! Only attached to public subnets via route tables

#### Public Subnets
```hcl
resource "aws_subnet" "public" {
  count = length(var.public_subnets)

  vpc_id                  = aws_vpc.main.id
  cidr_block              = var.public_subnets[count.index]
  availability_zone       = var.azs[count.index]
  map_public_ip_on_launch = true      # Instances get public IPs

  tags = merge(local.common_tags, {
    Name                     = "${local.name}-public-${var.azs[count.index]}"
    "kubernetes.io/role/elb" = "1"    # ðŸ‘ˆ Required for ALB Controller!
    Tier                     = "public"
  })
}
```

**Important tags:**
- `kubernetes.io/role/elb = "1"` â†’ Tells EKS where to place public load balancers

#### Private Subnets
```hcl
resource "aws_subnet" "private" {
  count = length(var.private_subnets)

  vpc_id            = aws_vpc.main.id
  cidr_block        = var.private_subnets[count.index]
  availability_zone = var.azs[count.index]

  tags = merge(local.common_tags, {
    Name                              = "${local.name}-private-${var.azs[count.index]}"
    "kubernetes.io/role/internal-elb" = "1"  # ðŸ‘ˆ For internal load balancers
    Tier                              = "private"
  })
}
```

**Why no `map_public_ip_on_launch`?**
- Private subnets don't need public IPs
- EKS nodes use NAT Gateway for outbound traffic

#### NAT Gateway
```hcl
resource "aws_eip" "nat" {
  count  = var.single_nat_gateway ? 1 : length(var.azs)
  domain = "vpc"

  depends_on = [aws_internet_gateway.main]
}

resource "aws_nat_gateway" "main" {
  count = var.single_nat_gateway ? 1 : length(var.azs)

  allocation_id = aws_eip.nat[count.index].id
  subnet_id     = aws_subnet.public[count.index].id
}
```

**Cost Decision:**
- `single_nat_gateway = true` â†’ 1 NAT ($32/month) 
- `single_nat_gateway = false` â†’ NAT per AZ ($64/month, but HA)
- For dev, we use single. For prod, use per-AZ.

#### Route Tables
```hcl
# Public routes to Internet Gateway
resource "aws_route_table" "public" {
  vpc_id = aws_vpc.main.id

  route {
    cidr_block = "0.0.0.0/0"
    gateway_id = aws_internet_gateway.main.id  # ðŸ‘ˆ Direct internet
  }
}

# Private routes to NAT Gateway
resource "aws_route_table" "private" {
  count  = var.single_nat_gateway ? 1 : length(var.azs)
  vpc_id = aws_vpc.main.id

  route {
    cidr_block     = "0.0.0.0/0"
    nat_gateway_id = aws_nat_gateway.main[var.single_nat_gateway ? 0 : count.index].id
  }
}
```

**Traffic flow:**
- Public subnet â†’ Internet Gateway â†’ Internet
- Private subnet â†’ NAT Gateway â†’ Internet Gateway â†’ Internet

#### S3 VPC Endpoint (Gateway - FREE!)
```hcl
resource "aws_vpc_endpoint" "s3" {
  count = var.enable_s3_endpoint ? 1 : 0

  vpc_id            = aws_vpc.main.id
  service_name      = "com.amazonaws.${data.aws_region.current.name}.s3"
  vpc_endpoint_type = "Gateway"
  route_table_ids   = concat(
    [aws_route_table.public.id],
    aws_route_table.private[*].id
  )
}
```

**Why enable S3 endpoint?**
- **FREE!** No cost for Gateway endpoints
- Reduces NAT data transfer costs
- ECR images are stored in S3, so this helps EKS

### Step 2.3: Understanding variables.tf

Key variables to know:

```hcl
variable "single_nat_gateway" {
  description = "Use single NAT Gateway (cost savings) vs one per AZ (HA)"
  type        = bool
  default     = true  # $32/month vs $64/month
}

variable "enable_s3_endpoint" {
  description = "Enable S3 VPC endpoint (reduces NAT traffic)"
  type        = bool
  default     = true  # FREE - always enable!
}

variable "enable_ecr_endpoints" {
  description = "Enable ECR VPC endpoints"
  type        = bool
  default     = false  # ~$15/month - enable for prod
}
```

---

## Part 3: Configure Dev Environment

### Step 3.1: Navigate to Dev Environment
```bash
cd ~/Desktop/Devops-Project/techitfactory-infra/environments/dev
```

### Step 3.2: Understanding main.tf VPC Configuration

```hcl
module "vpc" {
  source = "../../modules/vpc"

  project_name       = local.project_name
  environment        = local.environment
  vpc_cidr           = "10.0.0.0/16"
  single_nat_gateway = true   # ðŸ‘ˆ Cost optimization for dev
  enable_s3_endpoint = true   # ðŸ‘ˆ FREE - always enable

  # OPTIONAL: Interface endpoints (cost ~$7.50/month each)
  # Uncomment these for production:
  # enable_ecr_endpoints = true  # ~$15/month (2 endpoints)
  # enable_logs_endpoint = true  # ~$7.50/month
  # enable_sts_endpoint  = true  # ~$7.50/month
}
```

**Why interface endpoints are commented out?**
- Each costs ~$7.50/month
- For learning, NAT Gateway works fine
- For production, enable them for security

---

## Part 4: Apply VPC

### Step 4.1: Initialize Terraform
```bash
terraform init
```

### Step 4.2: Plan Changes
```bash
terraform plan

# Should show ~12-15 resources:
# - 1 VPC
# - 1 Internet Gateway
# - 2 Public Subnets
# - 2 Private Subnets
# - 1 EIP + 1 NAT Gateway
# - Route Tables + associations
# - 1 S3 Endpoint (FREE)
```

### Step 4.3: Apply
```bash
terraform apply

# Review the plan, then type 'yes'
# Takes 2-3 minutes (NAT Gateway creation is slow)
```

### Step 4.4: Verify Outputs
```bash
terraform output

# Note these values - needed for EKS later:
# - vpc_id
# - private_subnet_ids
# - public_subnet_ids
```

---

## Part 5: Verification

### Step 5.1: Check VPC in AWS
```bash
VPC_ID=$(terraform output -raw vpc_id)
echo "VPC ID: $VPC_ID"

aws ec2 describe-vpcs --vpc-ids $VPC_ID \
  --query "Vpcs[0].{ID:VpcId,CIDR:CidrBlock,DNS:EnableDnsHostnames}"
```

### Step 5.2: Check Subnets
```bash
aws ec2 describe-subnets --filters "Name=vpc-id,Values=$VPC_ID" \
  --query "Subnets[*].{Name:Tags[?Key=='Name'].Value|[0],AZ:AvailabilityZone,CIDR:CidrBlock}" \
  --output table
```

### Step 5.3: Check S3 Endpoint
```bash
aws ec2 describe-vpc-endpoints --filters "Name=vpc-id,Values=$VPC_ID" \
  --query "VpcEndpoints[*].{Service:ServiceName,Type:VpcEndpointType,State:State}" \
  --output table
```

---

## Cost Summary

| Resource | Monthly Cost | Notes |
|----------|--------------|-------|
| VPC | Free | - |
| Subnets | Free | - |
| Internet Gateway | Free | - |
| NAT Gateway | ~$32 | + $0.045/GB data transfer |
| Elastic IP | Free | When attached to NAT |
| S3 Endpoint (Gateway) | **FREE** | Always enable! |
| **Total** | **~$32/month** | - |

---

## Commit and Push

```bash
cd ~/Desktop/Devops-Project/techitfactory-infra
git add .
git commit -m "Deploy VPC with S3 endpoint"
git push origin main
```

---

## Key Takeaways

1. **Public vs Private Subnets**: Public for internet-facing, private for workloads
2. **NAT Gateway Cost**: $32/month - use single for dev, per-AZ for prod
3. **Kubernetes Tags**: Required for ALB Controller to discover subnets
4. **VPC Endpoints**: S3 is FREE, interface endpoints cost but improve security
5. **DNS Settings**: Always enable for EKS and AWS service integration

---

## Next: Story 4.1 (EKS Cluster)
With VPC ready, we can now provision the EKS cluster using the private subnets.
