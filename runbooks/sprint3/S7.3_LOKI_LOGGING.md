# Sprint 4, Story 8.3: Install Loki for Logging

## Story Summary
Set up Loki for centralized log aggregation and viewing in Grafana.

**What We're Installing:**
- Loki (log aggregation)
- Promtail (log collector)
- Grafana data source integration

---

## Prerequisites
- S8.1-8.2 completed (Prometheus + Grafana running)
- Helm installed

---

## Part 1: Install Loki Stack

### Step 1.1: Add Helm Repository
```bash
helm repo add grafana https://grafana.github.io/helm-charts
helm repo update
```

### Step 1.2: Create Values File
```bash
cat > loki-values.yaml << 'EOF'
loki:
  auth_enabled: false
  
  storage:
    type: 'filesystem'
  
  commonConfig:
    replication_factor: 1
  
  schemaConfig:
    configs:
      - from: 2024-01-01
        store: tsdb
        object_store: filesystem
        schema: v12
        index:
          prefix: loki_index_
          period: 24h

  limits_config:
    retention_period: 168h  # 7 days

singleBinary:
  replicas: 1
  persistence:
    enabled: true
    size: 50Gi

# Enable Promtail
promtail:
  enabled: true
  config:
    clients:
      - url: http://loki:3100/loki/api/v1/push
    
    snippets:
      pipelineStages:
        - cri: {}
        - json:
            expressions:
              level: level
              msg: msg
        - labels:
            level:

# For smaller installations
gateway:
  enabled: false

backend:
  replicas: 0

read:
  replicas: 0

write:
  replicas: 0
EOF
```

### Step 1.3: Install Loki
```bash
helm install loki grafana/loki-stack \
  -n monitoring \
  -f loki-values.yaml
```

---

## Part 2: Configure Grafana Data Source

### Step 2.1: Add Loki as Data Source
```bash
kubectl apply -f - <<EOF
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-loki-datasource
  namespace: monitoring
  labels:
    grafana_datasource: "1"
data:
  loki-datasource.yaml: |
    apiVersion: 1
    datasources:
      - name: Loki
        type: loki
        access: proxy
        url: http://loki:3100
        isDefault: false
        jsonData:
          maxLines: 1000
EOF
```

### Step 2.2: Restart Grafana
```bash
kubectl rollout restart deployment prometheus-grafana -n monitoring
```

---

## Part 3: Query Logs in Grafana

### Access Grafana Explore
1. Open Grafana
2. Go to Explore (compass icon)
3. Select "Loki" data source

### Basic LogQL Queries

```logql
# All logs from a namespace
{namespace="techitfactory"}

# Logs from specific pod
{namespace="techitfactory", pod=~"frontend.*"}

# Filter by log level
{namespace="techitfactory"} |= "error"

# JSON parsing
{namespace="techitfactory"} | json | level="error"

# Rate of errors
rate({namespace="techitfactory"} |= "error" [5m])

# Top 10 error messages
topk(10, sum by (msg) (rate({namespace="techitfactory"} | json | level="error" [5m])))
```

---

## Part 4: Create Log Dashboard

### Step 4.1: Log Dashboard ConfigMap
```bash
kubectl apply -f - <<EOF
apiVersion: v1
kind: ConfigMap
metadata:
  name: logs-dashboard
  namespace: monitoring
  labels:
    grafana_dashboard: "1"
data:
  logs.json: |
    {
      "annotations": {"list": []},
      "editable": true,
      "panels": [
        {
          "datasource": {"type": "loki", "uid": "loki"},
          "gridPos": {"h": 12, "w": 24, "x": 0, "y": 0},
          "id": 1,
          "options": {
            "dedupStrategy": "none",
            "enableLogDetails": true,
            "prettifyLogMessage": false,
            "showCommonLabels": false,
            "showLabels": false,
            "showTime": true,
            "sortOrder": "Descending",
            "wrapLogMessage": false
          },
          "targets": [
            {
              "expr": "{namespace=\"techitfactory\"}",
              "refId": "A"
            }
          ],
          "title": "Application Logs",
          "type": "logs"
        },
        {
          "datasource": {"type": "loki", "uid": "loki"},
          "gridPos": {"h": 8, "w": 12, "x": 0, "y": 12},
          "id": 2,
          "targets": [
            {
              "expr": "sum(rate({namespace=\"techitfactory\"} |= \"error\" [5m])) by (pod)",
              "legendFormat": "{{pod}}",
              "refId": "A"
            }
          ],
          "title": "Error Rate by Pod",
          "type": "timeseries"
        }
      ],
      "refresh": "10s",
      "schemaVersion": 36,
      "style": "dark",
      "tags": ["logs", "techitfactory"],
      "templating": {
        "list": [
          {
            "name": "namespace",
            "type": "query",
            "datasource": {"type": "loki", "uid": "loki"},
            "query": "label_values(namespace)",
            "refresh": 1
          }
        ]
      },
      "time": {"from": "now-1h", "to": "now"},
      "title": "TechITFactory Logs",
      "uid": "techitfactory-logs"
    }
EOF
```

---

## Part 5: Structured Logging Best Practices

### Node.js Example
```javascript
const winston = require('winston');

const logger = winston.createLogger({
  level: 'info',
  format: winston.format.combine(
    winston.format.timestamp(),
    winston.format.json()
  ),
  transports: [
    new winston.transports.Console()
  ]
});

// Usage
logger.info('Request received', { 
  method: 'GET', 
  path: '/api/users',
  userId: '123',
  duration: 45
});
```

### Go Example
```go
import "go.uber.org/zap"

logger, _ := zap.NewProduction()
defer logger.Sync()

logger.Info("Request received",
    zap.String("method", "GET"),
    zap.String("path", "/api/users"),
    zap.String("userId", "123"),
    zap.Int("duration", 45),
)
```

---

## Part 6: Log-based Alerts

### Create Alert Rule
```bash
kubectl apply -f - <<EOF
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: loki-alerts
  namespace: monitoring
  labels:
    release: prometheus
spec:
  groups:
    - name: loki
      rules:
        - alert: HighErrorRate
          expr: |
            sum(rate({namespace="techitfactory"} |= "error" [5m])) > 10
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "High error rate in logs"
            description: "More than 10 errors per second in techitfactory namespace"
EOF
```

---

## Verification

### Check Loki is Running
```bash
kubectl get pods -n monitoring | grep loki
kubectl logs -n monitoring -l app=loki --tail=50
```

### Verify Promtail is Collecting
```bash
kubectl get pods -n monitoring | grep promtail
kubectl logs -n monitoring -l app=promtail --tail=20
```

### Test Query
```bash
# Via port-forward
kubectl port-forward svc/loki -n monitoring 3100:3100
curl -G -s "http://localhost:3100/loki/api/v1/labels" | jq
```

---

## Story Completion Checklist
- [ ] Loki installed
- [ ] Promtail collecting logs
- [ ] Grafana data source configured
- [ ] Query logs in Explore
- [ ] Log dashboard created
- [ ] Structured logging in apps
- [ ] Log-based alerts configured

---

## Epic 8 Complete! ðŸŽ‰

**What we built:**
- Prometheus for metrics
- Grafana for visualization
- Loki for logs
- Alertmanager for notifications
- Custom dashboards and alerts

**Next: Epic 9 (Security & Compliance)**
