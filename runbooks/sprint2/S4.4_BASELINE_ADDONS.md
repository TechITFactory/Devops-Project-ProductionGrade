# Sprint 2, Story 4.4: Install Baseline Add-ons

## Story Summary
Install essential Kubernetes add-ons for a production-ready cluster.

**What We're Installing:**
- metrics-server (for HPA and `kubectl top`)
- AWS Load Balancer Controller (for ALB Ingress)
- External DNS (for Route53 automation)

---

## Prerequisites
- S4.1-4.3 completed
- EKS cluster running with healthy nodes

---

## Part 1: Install Metrics Server

### Step 1.1: Deploy Metrics Server
```bash
kubectl apply -f https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml
```

### Step 1.2: Verify Installation
```bash
# Wait a minute for metrics to be collected
kubectl get deployment metrics-server -n kube-system

# Test
kubectl top nodes
kubectl top pods -A
```

---

## Part 2: Install AWS Load Balancer Controller

### Step 2.1: Create IRSA Role
```bash
# Add to EKS module or apply via Terraform

# Policy document from AWS
curl -o iam_policy.json https://raw.githubusercontent.com/kubernetes-sigs/aws-load-balancer-controller/main/docs/install/iam_policy.json

# Create policy
aws iam create-policy \
  --policy-name AWSLoadBalancerControllerIAMPolicy \
  --policy-document file://iam_policy.json
```

### Step 2.2: Create Service Account
```bash
eksctl create iamserviceaccount \
  --cluster=techitfactory-dev \
  --namespace=kube-system \
  --name=aws-load-balancer-controller \
  --attach-policy-arn=arn:aws:iam::$(aws sts get-caller-identity --query Account --output text):policy/AWSLoadBalancerControllerIAMPolicy \
  --approve \
  --region=ap-south-1
```

### Step 2.3: Install Controller via Helm
```bash
# Add Helm repo
helm repo add eks https://aws.github.io/eks-charts
helm repo update eks

# Install controller
helm install aws-load-balancer-controller eks/aws-load-balancer-controller \
  -n kube-system \
  --set clusterName=techitfactory-dev \
  --set serviceAccount.create=false \
  --set serviceAccount.name=aws-load-balancer-controller
```

### Step 2.4: Verify Installation
```bash
kubectl get deployment aws-load-balancer-controller -n kube-system
kubectl logs -f deployment/aws-load-balancer-controller -n kube-system
```

---

## Part 3: Install External DNS (Optional)

### Step 3.1: Create IRSA Role for External DNS
```bash
# Policy for Route53 access
cat > external-dns-policy.json << 'EOF'
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": ["route53:ChangeResourceRecordSets"],
      "Resource": ["arn:aws:route53:::hostedzone/*"]
    },
    {
      "Effect": "Allow",
      "Action": [
        "route53:ListHostedZones",
        "route53:ListResourceRecordSets"
      ],
      "Resource": ["*"]
    }
  ]
}
EOF

aws iam create-policy \
  --policy-name ExternalDNSPolicy \
  --policy-document file://external-dns-policy.json

eksctl create iamserviceaccount \
  --cluster=techitfactory-dev \
  --namespace=kube-system \
  --name=external-dns \
  --attach-policy-arn=arn:aws:iam::$(aws sts get-caller-identity --query Account --output text):policy/ExternalDNSPolicy \
  --approve \
  --region=ap-south-1
```

### Step 3.2: Deploy External DNS
```bash
helm repo add external-dns https://kubernetes-sigs.github.io/external-dns/
helm repo update

helm install external-dns external-dns/external-dns \
  -n kube-system \
  --set serviceAccount.create=false \
  --set serviceAccount.name=external-dns \
  --set provider=aws \
  --set aws.region=ap-south-1 \
  --set txtOwnerId=techitfactory-dev \
  --set domainFilters[0]=yourdomain.com  # Replace with your domain
```

---

## Part 4: Test ALB Ingress

### Step 4.1: Deploy Sample App
```bash
cat <<EOF | kubectl apply -f -
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-test
spec:
  replicas: 2
  selector:
    matchLabels:
      app: nginx-test
  template:
    metadata:
      labels:
        app: nginx-test
    spec:
      containers:
      - name: nginx
        image: nginx:alpine
        ports:
        - containerPort: 80
---
apiVersion: v1
kind: Service
metadata:
  name: nginx-test
spec:
  selector:
    app: nginx-test
  ports:
  - port: 80
    targetPort: 80
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: nginx-test
  annotations:
    kubernetes.io/ingress.class: alb
    alb.ingress.kubernetes.io/scheme: internet-facing
    alb.ingress.kubernetes.io/target-type: ip
spec:
  rules:
  - http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: nginx-test
            port:
              number: 80
EOF
```

### Step 4.2: Get ALB URL
```bash
kubectl get ingress nginx-test
# Note the ADDRESS column - this is your ALB URL

curl http://<ALB-URL>
# Should return nginx welcome page
```

### Step 4.3: Cleanup Test
```bash
kubectl delete ingress nginx-test
kubectl delete service nginx-test
kubectl delete deployment nginx-test
```

---

## Verification

### Check All Add-ons
```bash
echo "=== Metrics Server ==="
kubectl get deployment metrics-server -n kube-system

echo "=== AWS LB Controller ==="
kubectl get deployment aws-load-balancer-controller -n kube-system

echo "=== External DNS ==="
kubectl get deployment external-dns -n kube-system 2>/dev/null || echo "Not installed"

echo "=== EKS Add-ons ==="
aws eks list-addons --cluster-name techitfactory-dev
```

### Test HPA Capability
```bash
# HPA requires metrics-server
kubectl autoscale deployment nginx-test --min=1 --max=5 --cpu-percent=50
kubectl get hpa
```

---

## Summary of Add-ons Installed

| Add-on | Purpose | Installed |
|--------|---------|-----------|
| CoreDNS | Cluster DNS | âœ… (EKS managed) |
| kube-proxy | Network proxy | âœ… (EKS managed) |
| VPC CNI | Pod networking | âœ… (EKS managed) |
| EBS CSI | Persistent volumes | âœ… (EKS managed) |
| Metrics Server | Pod/node metrics | âœ… |
| Cluster Autoscaler | Node autoscaling | âœ… (S4.3) |
| ALB Controller | AWS ALB Ingress | âœ… |
| External DNS | Route53 automation | Optional |

---

## Story Completion Checklist
- [ ] metrics-server installed and working
- [ ] kubectl top nodes/pods works
- [ ] AWS LB Controller installed
- [ ] Test Ingress creates ALB
- [ ] (Optional) External DNS installed
- [ ] All add-ons healthy

---

## Epic 4 Complete! ðŸŽ‰

**What we built:**
- EKS cluster with managed node group
- IAM/SSO access configuration
- Cluster Autoscaler for node scaling
- Baseline add-ons for production

**Next: Epic 5 (Ingress + Domain)**
