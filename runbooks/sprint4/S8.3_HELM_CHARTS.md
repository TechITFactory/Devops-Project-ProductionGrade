# Sprint 4, Story 8.3: Create Helm Charts

## Story Summary
Create Helm charts for deploying microservices to Kubernetes.

**What We're Creating:**
- Reusable Helm chart template
- Per-service values files
- Resource limits and probes

---

## Prerequisites
- S8.1 (ECR repositories) completed
- S8.2 (Dockerfiles) completed
- Helm 3.x installed

---

## Part 1: Chart Structure

### Step 1.1: Create Base Chart
```bash
cd ~/Desktop/Devops-Project/techitfactory-app
mkdir -p charts/microservice

# Generate chart skeleton
helm create charts/microservice
```

### Step 1.2: Chart Directory Structure
```
charts/microservice/
├── Chart.yaml
├── values.yaml
├── templates/
│   ├── deployment.yaml
│   ├── service.yaml
│   ├── ingress.yaml
│   ├── serviceaccount.yaml
│   ├── hpa.yaml
│   └── _helpers.tpl
└── values/
    ├── frontend.yaml
    ├── api-gateway.yaml
    ├── product-service.yaml
    └── order-service.yaml
```

---

## Part 2: Chart Templates

### Step 2.1: Chart.yaml
```yaml
apiVersion: v2
name: microservice
description: Generic microservice Helm chart
type: application
version: 1.0.0
appVersion: "1.0.0"
```

### Step 2.2: values.yaml (Default)
```yaml
replicaCount: 2

image:
  repository: ""
  tag: "latest"
  pullPolicy: IfNotPresent

service:
  type: ClusterIP
  port: 80
  targetPort: 3000

resources:
  requests:
    cpu: 100m
    memory: 128Mi
  limits:
    cpu: 500m
    memory: 256Mi

probes:
  liveness:
    path: /health
    port: 3000
    initialDelaySeconds: 10
    periodSeconds: 10
  readiness:
    path: /ready
    port: 3000
    initialDelaySeconds: 5
    periodSeconds: 5

autoscaling:
  enabled: false
  minReplicas: 2
  maxReplicas: 10
  targetCPUUtilization: 70

env: []

serviceAccount:
  create: true
  annotations: {}
```

### Step 2.3: templates/deployment.yaml
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "microservice.fullname" . }}
  labels:
    {{- include "microservice.labels" . | nindent 4 }}
spec:
  {{- if not .Values.autoscaling.enabled }}
  replicas: {{ .Values.replicaCount }}
  {{- end }}
  selector:
    matchLabels:
      {{- include "microservice.selectorLabels" . | nindent 6 }}
  template:
    metadata:
      labels:
        {{- include "microservice.selectorLabels" . | nindent 8 }}
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "{{ .Values.service.targetPort }}"
        prometheus.io/path: "/metrics"
    spec:
      serviceAccountName: {{ include "microservice.serviceAccountName" . }}
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
      containers:
        - name: {{ .Chart.Name }}
          image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
          imagePullPolicy: {{ .Values.image.pullPolicy }}
          ports:
            - containerPort: {{ .Values.service.targetPort }}
          livenessProbe:
            httpGet:
              path: {{ .Values.probes.liveness.path }}
              port: {{ .Values.probes.liveness.port }}
            initialDelaySeconds: {{ .Values.probes.liveness.initialDelaySeconds }}
            periodSeconds: {{ .Values.probes.liveness.periodSeconds }}
          readinessProbe:
            httpGet:
              path: {{ .Values.probes.readiness.path }}
              port: {{ .Values.probes.readiness.port }}
            initialDelaySeconds: {{ .Values.probes.readiness.initialDelaySeconds }}
            periodSeconds: {{ .Values.probes.readiness.periodSeconds }}
          resources:
            {{- toYaml .Values.resources | nindent 12 }}
          env:
            - name: NODE_ENV
              value: "production"
            {{- range .Values.env }}
            - name: {{ .name }}
              value: {{ .value | quote }}
            {{- end }}
```

### Step 2.4: templates/service.yaml
```yaml
apiVersion: v1
kind: Service
metadata:
  name: {{ include "microservice.fullname" . }}
  labels:
    {{- include "microservice.labels" . | nindent 4 }}
spec:
  type: {{ .Values.service.type }}
  ports:
    - port: {{ .Values.service.port }}
      targetPort: {{ .Values.service.targetPort }}
      protocol: TCP
  selector:
    {{- include "microservice.selectorLabels" . | nindent 4 }}
```

### Step 2.5: templates/hpa.yaml
```yaml
{{- if .Values.autoscaling.enabled }}
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: {{ include "microservice.fullname" . }}
  labels:
    {{- include "microservice.labels" . | nindent 4 }}
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: {{ include "microservice.fullname" . }}
  minReplicas: {{ .Values.autoscaling.minReplicas }}
  maxReplicas: {{ .Values.autoscaling.maxReplicas }}
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: {{ .Values.autoscaling.targetCPUUtilization }}
{{- end }}
```

---

## Part 3: Per-Service Values

### Step 3.1: Frontend Values
```yaml
# values/frontend.yaml
replicaCount: 2

image:
  repository: <AWS_ACCOUNT>.dkr.ecr.ap-south-1.amazonaws.com/techitfactory/frontend
  tag: latest

service:
  port: 80
  targetPort: 80

resources:
  requests:
    cpu: 100m
    memory: 128Mi
  limits:
    cpu: 500m
    memory: 256Mi

probes:
  liveness:
    path: /health
    port: 80
  readiness:
    path: /
    port: 80
```

### Step 3.2: API Gateway Values
```yaml
# values/api-gateway.yaml
replicaCount: 2

image:
  repository: <AWS_ACCOUNT>.dkr.ecr.ap-south-1.amazonaws.com/techitfactory/api-gateway
  tag: latest

service:
  port: 80
  targetPort: 3000

env:
  - name: PRODUCT_SERVICE_URL
    value: "http://product-service"
  - name: ORDER_SERVICE_URL
    value: "http://order-service"
  - name: USER_SERVICE_URL
    value: "http://user-service"
```

---

## Part 4: Deploy with Helm

### Install Service
```bash
helm upgrade --install frontend ./charts/microservice \
  -f ./charts/microservice/values/frontend.yaml \
  -n techitfactory \
  --create-namespace
```

### List Releases
```bash
helm list -n techitfactory
```

### Uninstall
```bash
helm uninstall frontend -n techitfactory
```

---

## Part 5: GitOps Integration

### ArgoCD Application
```yaml
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: frontend
  namespace: argocd
spec:
  project: default
  source:
    repoURL: https://github.com/TechITFactory/techitfactory-app.git
    path: charts/microservice
    helm:
      valueFiles:
        - values/frontend.yaml
  destination:
    server: https://kubernetes.default.svc
    namespace: techitfactory
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
```

---

## Verification

### Template Dry Run
```bash
helm template frontend ./charts/microservice -f ./charts/microservice/values/frontend.yaml
```

### Lint Chart
```bash
helm lint ./charts/microservice
```

---

## Story Completion Checklist
- [ ] Base chart created
- [ ] Deployment template with probes
- [ ] Service template
- [ ] HPA template
- [ ] Per-service values files
- [ ] Chart linting passes
- [ ] Helm install works
- [ ] GitOps integration ready

---

## Next: Story 8.4 (Service Implementation)
