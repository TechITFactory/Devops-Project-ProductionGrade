# Sprint 3, Story 7.1: Install ArgoCD

## Story Summary
Install ArgoCD for GitOps-based continuous deployment.

**What We're Installing:**
- ArgoCD Server (UI + API)
- ArgoCD Repo Server (Git sync)
- ArgoCD Application Controller
- ArgoCD Redis (caching)

---

## Prerequisites
- EKS cluster running
- kubectl configured
- ALB Controller installed (for ingress)

---

## Part 1: Install ArgoCD

### Step 1.1: Create Namespace
```bash
kubectl create namespace argocd
```

### Step 1.2: Install ArgoCD
```bash
kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml
```

### Step 1.3: Wait for Pods
```bash
kubectl get pods -n argocd -w
# Wait until all pods are Running
```

---

## Part 2: Expose ArgoCD UI

### Option A: Port Forward (Development)
```bash
kubectl port-forward svc/argocd-server -n argocd 8080:443
# Access: https://localhost:8080
```

### Option B: ALB Ingress (Production)
```bash
kubectl apply -f - <<EOF
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: argocd-server
  namespace: argocd
  annotations:
    alb.ingress.kubernetes.io/scheme: internet-facing
    alb.ingress.kubernetes.io/target-type: ip
    alb.ingress.kubernetes.io/backend-protocol: HTTPS
    alb.ingress.kubernetes.io/healthcheck-path: /healthz
    alb.ingress.kubernetes.io/healthcheck-protocol: HTTPS
spec:
  ingressClassName: alb
  rules:
  - host: argocd.yourdomain.com  # Replace with your domain
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: argocd-server
            port:
              number: 443
EOF
```

---

## Part 3: Get Admin Password

### Step 3.1: Get Initial Password
```bash
# ArgoCD generates a random password
kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d
echo  # For newline
```

### Step 3.2: Login via CLI
```bash
# Install argocd CLI
# Linux
curl -sSL -o argocd https://github.com/argoproj/argo-cd/releases/latest/download/argocd-linux-amd64
chmod +x argocd
sudo mv argocd /usr/local/bin/

# Login (if using port-forward)
argocd login localhost:8080 --username admin --password <PASSWORD> --insecure
```

### Step 3.3: Change Password
```bash
argocd account update-password
```

---

## Part 4: Configure GitHub Repository

### Step 4.1: Add SSH Key (Private Repos)
```bash
# Generate deploy key
ssh-keygen -t ed25519 -C "argocd@techitfactory" -f argocd-deploy-key -N ""

# Add public key to GitHub repo as deploy key
cat argocd-deploy-key.pub
# Go to: GitHub Repo → Settings → Deploy Keys → Add

# Add private key to ArgoCD
argocd repo add git@github.com:TechITFactory/techitfactory-gitops.git \
  --ssh-private-key-path argocd-deploy-key
```

### Step 4.2: Add HTTPS Repository (Public Repos)
```bash
argocd repo add https://github.com/TechITFactory/techitfactory-gitops.git
```

---

## Part 5: Configure RBAC

### Step 5.1: Create Developer Role
```bash
kubectl apply -f - <<EOF
apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-rbac-cm
  namespace: argocd
data:
  policy.csv: |
    # Developers can view and sync
    p, role:developer, applications, get, */*, allow
    p, role:developer, applications, sync, */*, allow
    p, role:developer, logs, get, */*, allow
    
    # Ops can do everything
    p, role:ops, applications, *, */*, allow
    p, role:ops, clusters, *, *, allow
    p, role:ops, repositories, *, *, allow
    
    # Map groups
    g, developers, role:developer
    g, ops, role:ops
  policy.default: role:readonly
EOF
```

---

## Verification

### Check ArgoCD Status
```bash
kubectl get pods -n argocd
kubectl get svc -n argocd
argocd app list
```

### Access UI
- **Port Forward:** https://localhost:8080
- **With Ingress:** https://argocd.yourdomain.com

---

## Story Completion Checklist
- [ ] ArgoCD namespace created
- [ ] ArgoCD installed
- [ ] All pods running
- [ ] UI accessible
- [ ] Admin password retrieved
- [ ] CLI installed and logged in
- [ ] Git repository connected
- [ ] RBAC configured

---

## Next: Story 7.2 (App-of-Apps Pattern)
