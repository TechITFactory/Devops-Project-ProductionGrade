# Sprint 5, Story 9.2: SonarCloud Integration

## Story Summary
Integrate SonarCloud for code quality analysis and security scanning.

**What We're Configuring:**
- SonarCloud project setup
- Quality gates in PRs
- Code coverage reporting

---

## Prerequisites
- GitHub repository connected to SonarCloud
- SonarCloud account and organization

---

## Part 1: SonarCloud Setup

### Step 1.1: Create SonarCloud Account
1. Go to https://sonarcloud.io
2. Sign in with GitHub
3. Import your organization

### Step 1.2: Import Repository
1. Click "Analyze new project"
2. Select `techitfactory-app`
3. Choose "With GitHub Actions"

### Step 1.3: Get Token
1. Go to My Account → Security
2. Generate token for `techitfactory-app`
3. Add as GitHub secret: `SONAR_TOKEN`

---

## Part 2: SonarCloud Configuration

### Step 2.1: Create sonar-project.properties
```properties
# sonar-project.properties (root of repo)
sonar.organization=techitfactory
sonar.projectKey=TechITFactory_techitfactory-app

# Monorepo configuration
sonar.sources=services
sonar.exclusions=**/node_modules/**,**/dist/**,**/__pycache__/**

# Language-specific settings
sonar.javascript.lcov.reportPaths=services/*/coverage/lcov.info
sonar.python.coverage.reportPaths=services/*/coverage.xml

# Quality Gate
sonar.qualitygate.wait=true
```

---

## Part 3: GitHub Actions Integration

### Step 3.1: Add SonarCloud to Workflow
```yaml
# Add to each service workflow or create dedicated workflow
name: SonarCloud Analysis

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  sonarcloud:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better analysis

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          for dir in services/*/; do
            if [ -f "$dir/package.json" ]; then
              cd "$dir"
              npm ci
              cd ../..
            fi
          done

      - name: Run tests with coverage
        run: |
          for dir in services/*/; do
            if [ -f "$dir/package.json" ]; then
              cd "$dir"
              npm test -- --coverage --coverageReporters=lcov || true
              cd ../..
            fi
          done

      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
```

---

## Part 4: Quality Gates

### Default Quality Gate Conditions
- **New Code Coverage** > 80%
- **Duplicated Lines** < 3%
- **Maintainability Rating** = A
- **Reliability Rating** = A
- **Security Rating** = A

### Custom Quality Gate
1. Go to Quality Gates in SonarCloud
2. Create new gate "TechITFactory"
3. Configure conditions:
   - Coverage on New Code >= 70%
   - Bugs = 0
   - Vulnerabilities = 0
   - Code Smells severity >= Major = 0

---

## Part 5: PR Decoration

### Enable PR Comments
1. Go to Administration → General Settings → Pull Requests
2. Enable "Decorate pull requests"
3. SonarCloud will automatically comment on PRs

### Example PR Comment
```
Quality Gate passed

Coverage: 85.2% (+2.1%)
Duplications: 1.2%
Bugs: 0
Vulnerabilities: 0
Code Smells: 3 (minor)
```

---

## Part 6: Branch Analysis

### Configure Branch Analysis
```yaml
# In workflow
- name: SonarCloud Scan
  uses: SonarSource/sonarcloud-github-action@master
  env:
    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
  with:
    args: >
      -Dsonar.branch.name=${{ github.head_ref || github.ref_name }}
```

---

## Verification

### Check Analysis Results
1. Push code or create PR
2. Wait for workflow to complete
3. Check SonarCloud dashboard
4. Verify PR decoration
5. Check Quality Gate status

---

## Story Completion Checklist
- [ ] SonarCloud account created
- [ ] Project imported
- [ ] SONAR_TOKEN secret added
- [ ] sonar-project.properties created
- [ ] Workflow integration done
- [ ] Quality Gate configured
- [ ] PR decoration working

---

## Next: Story 9.3 (Dev Auto-Deploy)
